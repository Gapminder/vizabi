(function(){"use strict";function a(a,b,d){var e=c.Tool.get(a);if(e){var f=new e(b,d);return c._instances[f._id]=f,f}c.utils.error('Tool "'+a+'" was not found.')}var b=this,c=(b.Vizabi,function(b,c,d){return a(b,c,d)});c._instances={},c.clearInstances=function(a){a?delete c._instances[a]:c._instances={}},c._require=function(a){return"undefined"==typeof b[a]?(c.utils.warn(a+" is required and could not be found."),!1):!0},"function"==typeof define&&define.amd?define(function(){return c}):"object"==typeof module&&module.exports&&(module.exports=c),b.Vizabi=c}).call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils={uniqueId:function(){var a=0;return function(b){return b?b+a++:a++}}(),isElement:function(a){return!(!a||1!==a.nodeType)},isArray:Array.isArray||function(a){return"[object Array]"===toString.call(a)},isObject:function(a){var b=typeof a;return"object"===b&&!!a},isDate:function(a){return a instanceof Date},isPlainObject:function(a){return null!=a&&"[object Object]"===Object.prototype.toString.call(a)},forEach:function(a,b,c){if(a)if(this.isArray(a)){var d;for(d=0;d<a.length&&b.apply(c,[a[d],d])!==!1;d++);}else for(var e in a)if(b.apply(c,[a[e],e])===!1)break},extend:function(a){var b=Array.prototype.slice.call(arguments,1),c=this;return this.forEach(b,function(b,d){c.forEach(b,function(c,d){b.hasOwnProperty(d)&&(a[d]=c)})}),a},merge:function(a){var b=Array.prototype.slice.call(arguments,1),c=this;return this.forEach(b,function(b,d){c.forEach(b,function(d,e){b.hasOwnProperty(e)&&(a.hasOwnProperty(e)?(c.isArray(a[e])||(a[e]=[a[e]]),a[e].push(d)):a[e]=d)})}),a},clone:function(a,b){if(this.isArray(a))return a.slice(0);var c={};return this.forEach(a,function(d,e){b&&-1===b.indexOf(e)||a.hasOwnProperty(e)&&(c[e]=d)}),c},deepClone:function(a){var b={},c=this;return this.forEach(a,function(d,e){a.hasOwnProperty(e)&&(c.isObject(d)||c.isArray(d)?b[e]=c.deepClone(d):b[e]=d)}),b},without:function(a,b){var c=a.indexOf(b);return-1!==c&&a.splice(c,1),a},unique:function(a,b){var c={},d=[];b||(b=function(a){return a});for(var e=0,f=a.length;f>e;++e){var g=b(a[e]);c.hasOwnProperty(g)||(d.push(a[e]),c[g]=1)}return d},find:function(a,b){var c;return this.forEach(a,function(a){return b(a)?(c=a,!1):void 0}),c},filter:function(a,b){return a.filter(function(a){for(var c in b)if(a[c]!==b[c])return!1;return!0})},radiusToArea:function(a){return a*a*Math.PI},areaToRadius:function(a){return Math.sqrt(a/Math.PI)},timeStamp:function(b){a.console&&"function"==typeof a.console.timeStamp&&a.console.timeStamp(b)},warn:function(b){a.console&&"function"==typeof a.console.warn&&a.console.warn(b)},groupCollapsed:function(b){a.console&&"function"==typeof a.console.groupCollapsed&&a.console.groupCollapsed(b)},groupEnd:function(){a.console&&"function"==typeof a.console.groupEnd&&a.console.groupEnd()},error:function(b){a.console&&"function"==typeof a.console.error&&a.console.error(b)},countDecimals:function(a){return Math.floor(a.valueOf())===a.valueOf()?0:a.toString().split(".")[1].length||0},addClass:function(a,b){a.classList?a.classList.add(b):a.className+=" "+b},removeClass:function(a,b){a.classList?a.classList.remove(b):a.className=a.className.replace(new RegExp("(^|\\b)"+b.split(" ").join("|")+"(\\b|$)","gi")," ")},classed:function(a,b,c){if(c===!0)this.addClass(a,b);else{if(c!==!1)return this.hasClass(a,b);this.removeClass(a,b)}},hasClass:function(a,b){return a.classList?a.classList.contains(b):new RegExp("(^| )"+b+"( |$)","gi").test(a.className)},throttle:function(){var a={};return function(b,c){a[b]||(a[b]=!0,setTimeout(function(){a[b]=!1},c),b())}}(),values:function(a){var b;for(var c in a)(b=b||[]).push(a[c]);return b},defer:function(a){setTimeout(a,1)},ajax:function(a){var b=new XMLHttpRequest;b.open(a.method,a.url,!0),"POST"===a.method&&b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.onload=function(){if(b.status>=200&&b.status<400){var c=a.json?JSON.parse(b.responseText):b.responseText;a.success&&a.success(c)}else a.error&&a.error()},b.onerror=function(){a.error&&a.error()},b.send(a.data)},get:function(a,b,c,d,e){var b=[];this.forEach(b,function(a,c){b.push(c+"="+a)}),a=b.length?a+"?"+b.join("&"):a,this.ajax({method:"GET",url:a,success:c,error:d,json:e})},post:function(a,b,c,d,e){this.ajax({method:"POST",url:a,success:c,error:d,json:e,data:b})}}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Promise=b.call(a)}(b,function(){function a(b){return this instanceof a?(this.status="pending",this.value,this.reason,this._resolves=[],this._rejects=[],g(b)&&b(this.resolve.bind(this),this.reject.bind(this)),this):new a(b)}function b(b,c){return c===b&&b.reject(new Error("TypeError")),c instanceof a?d(b,c):i(c)?e(b,c):b.resolve(c)}function d(a,b){var c=b.status;return"pending"===c&&b.then(a.resolve.bind(a),a.reject.bind(a)),"resolved"===c&&a.resolve(b.value),"rejected"===c&&a.reject(b.reason),promise}function e(a,c){var d,e=j(function(c){d||(b(a,c),d=!0)}),f=j(function(b){d||(a.reject(b),d=!0)});try{c.then.call(c,e,f)}catch(g){if(!d)throw g;a.reject(g)}return a}function f(a){for(var c,d,e=a.status,f=a["resolved"===e?"_resolves":"_rejects"],g=a["resolved"===e?"value":"reason"];c=f.shift();)d=c.call(a,g),d&&b(a._next,d);return a}function g(a){return"function"===h(a)}function h(a){var b={};return b.toString.call(a).replace(/\[object (\w+)\]/,"$1").toLowerCase()}function i(a){return a&&a.then&&g(a.then)}function j(a){var b,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}}return a.prototype.then=function(c,d){var e,f=this._next||(this._next=a()),h=this.status;if("pending"===h)return g(c)&&this._resolves.push(c),g(d)&&this._rejects.push(d),f;if("resolved"===h){if(g(c))try{e=c(this.value),b(f,e)}catch(i){this.reject(i)}else f.resolve(c);return f}if("rejected"===h){if(g(d))try{e=d(this.reason),b(f,e)}catch(i){this.reject(i)}else f.reject(d);return f}},a.prototype.resolve=function(a){if("rejected"===this.status)throw Error("Illegal call.");return this.status="resolved",this.value=a,this._resolves.length&&f(this),this},a.prototype.reject=function(a){if("resolved"===this.status)throw Error("Illegal call. "+a);return this.status="rejected",this.reason=a,this._rejects.length&&f(this),this},a.prototype["catch"]=function(a){return this.then(void 0,a)},a.cast=function(b){var c=a();return b instanceof a?d(c,b):a.resolve(b)},a.resolve=function(b){var c=a();return i(b)?e(c,b):c.resolve(b)},a.all=function(b){var d,e=b.length,f=a(),g=[],h=0;return c.forEach(b,function(a,b){a.then(function(a){g[b]=a,++h!==e||d||f.resolve(g)},function(a){d=!0,f.reject(a)})}),f},a.any=function(b){var d,e=a();return c.forEach(b,function(a,b){a.then(function(a){d||(e.resolve(a),d=!0)},function(a){d=!0,e.reject(a)})}),e},a.reject=function(b){if(!(b instanceof Error))throw Error("reason must be an instance of Error");var c=a();return c.reject(b),c},a})}.call(this),function(){"use strict";function a(b,f){function g(){!d&&this.init&&this.init.apply(this,arguments)}f=1===arguments.length?b:f;var h=this.prototype;d=!0;var i=new this;return d=!1,c.utils.forEach(f,function(a,b){"function"==typeof f[b]&&"function"==typeof h[b]&&e.test(f[b])?i[b]=function(a,b){return function(){var c=this._super;this._super=h[a];var d=b.apply(this,arguments);return this._super=c,d}}(b,f[b]):i[b]=a}),g.prototype=i,g.prototype.constructor=g,g.extend=a,g._collection={},g.register=function(a,b){"undefined"!=typeof this._collection[a]&&c.utils.warn('"'+a+'" is already registered. Overwriting...'),this._collection[a]=b},g.unregister=function(a){delete this._collection[a]},g.getCollection=function(){return this._collection},g.get=function(a,b){return this._collection.hasOwnProperty(a)?this._collection[a]:(b||c.utils.warn('"'+a+'" was not found.'),!1)},arguments.length>1&&this.register&&this.register(b,g),g}var b=this,c=b.Vizabi,d=!1,e=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;c.Class=function(){},c.Class.extend=a,c.Helper=c.Class.extend({})}.call(this),function(){"use strict";function a(a,b,c){return JSON.stringify(a)+b+JSON.stringify(c)}var b=this,c=b.Vizabi,d=c.utils,e=c.Promise,f=c.Class.extend({init:function(){this._data={}},load:function(a,b,c,f){var g=this,h=new e,i=(new e).resolve(),j=a===!0?!0:this.isCached(a,b,c),k=!1;return j||(d.timeStamp("Vizabi Data: Loading Data"),f&&"function"==typeof f.load_start&&f.load_start(),i=new e,this.loadFromReader(a,b,c).then(function(a){k=!0,j=a,i.resolve()})),i.then(function(){var a=g.get(j);k&&f&&"function"==typeof f.load_end&&f.load_end(),h.resolve(a)},function(){k&&f&&"function"==typeof f.load_end&&f.load_end(),h.reject("Error loading file...")}),h},loadFromReader:function(b,d,f){var g=this,h=new e,i=f.reader,j=a(b,d,f),k=c.Reader.get(i),l=new k(f);return l.read(b,d).then(function(){var a=l.getData(),c=b,d=-1!==c.select.indexOf("geo.region");a=a.map(function(a){for(var b=0;b<c.select.length;b++){var d=c.select[b];"undefined"==typeof a[d]&&(a[d]=null)}return a}),a=a.map(function(a){return null===a.geo&&(a.geo=a["geo.name"]),d&&null===a["geo.region"]&&(a["geo.region"]=a.geo),a}),a=a.map(function(a){return a.time=new Date(a.time),a.time.setHours(0),a}),a.sort(function(a,b){return a.time-b.time}),g._data[j]=a,h.resolve(j)},function(a){h.reject(a)}),h},get:function(a){return a?this._data[a]:this._data},isCached:function(b,c,d){var e=a(b,c,d);return-1!==Object.keys(this._data).indexOf(e)?e:!1},clear:function(){this._data={}}}),g=c.Class.extend({init:function(a){this._name=this._name||a.reader,this._data=a.data||[],this._basepath=this._basepath||a.path||null},read:function(a,b){return new e.resolve(this._data)},getData:function(){return this._data}});c.Reader=g,c.Data=f}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=!1,e=[],f={},g=b.Class.extend({init:function(a,b){this._id=this._id||c.uniqueId("e"),this._events={},this._freeze=!1,this._freezer=[],this._freezeExceptions={}},on:function(a,b){var d;if(c.isArray(b))for(d=0;d<b.length;d++)this.on(a,b[d]);else if(c.isArray(a))for(d=0;d<a.length;d++)this.on(a[d],b);else if(c.isObject(a))for(d in a)this.on(d,a[d]);else this._events[a]=this._events[a]||[],"function"==typeof b?this._events[a].push(b):c.warn("Can't bind event '"+a+"'. It must be a function.")},unbind:function(a){if(c.isArray(a))for(var b=0;b<a.length;b++)this.unbind(a[b]);else this._events.hasOwnProperty(a)&&(this._events[a]=[])},unbindAll:function(){this._events={}},trigger:function(a,b,g){var h;if(c.isArray(a))for(h=0,size=a.length;h<size;h++)this.trigger(a[h],b);else{if(!this._events.hasOwnProperty(a))return;for(h=0;h<this._events[a].length;h++){var i=this._events[a][h],j=this,k=function(){var d="Vizabi Event: "+a+" - "+g;c.timeStamp(d),i.apply(j,[g||a,b])};this._freeze||d?d&&f.hasOwnProperty(a)||!d&&this._freeze&&this._freezeExceptions.hasOwnProperty(a)?k():(this._freezer.push(k),d&&!e[this._id]&&(this.freeze(),e[this._id]=this)):k()}}},triggerAll:function(a,b){if(c.isArray(a))for(var d=0,e=a.length;e>d;d++)this.triggerAll(a[d],b);else for(var f=a,g=a.split(":");g.length;)this.trigger(a,b,f),g.pop(),a=g.join(":")},freeze:function(a){if(this._freeze=!0,a){c.isArray(a)||(a=[a]);for(var b=0;b<a.length;b++)this._freezeExceptions[a[b]]=!0}},unfreeze:function(){for(this._freeze=!1,this._freezeExceptions={};this._freezer.length;){var a=this._freezer.shift();a()}}});g.freezeAll=function(a){d=!0,a&&(c.isArray(a)||(a=[a]),c.forEach(a,function(a){f[a]=!0}))},g.unfreezeAll=function(){d=!1,f={};for(var a in e){var b=e[a];b.unfreeze(),delete e[a]}},b.Events=g}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=(b.utils,b.Class.extend({init:function(){this.intervals={}},setInterval:function(a,b,c){this.clearInterval(a),this.intervals[a]=setInterval(b,c)},clearInterval:function(a){return a?clearInterval(this.intervals[a]):this.clearAllIntervals()},clearAllIntervals:function(){for(var a in this.intervals)this.clearInterval(a)}}));b.Intervals=c}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d="vzb-",e="vzb-portrait",f="vzb-landscape",g={small:{min_width:0,max_width:749},medium:{min_width:750,max_width:969},large:{min_width:970,max_width:1/0}},h=b.Events.extend({init:function(){this._container=null,this._curr_profile=null,this._prev_size={};var b=this;a.addEventListener("resize",function(){b._container&&b.setSize()}),this._super()},setSize:function(){var a=this,b=this._container.clientWidth,h=this._container.clientHeight;this._prev_size&&this._prev_size.width===b&&this._prev_size.height===h||(c.forEach(g,function(e,f){c.removeClass(a._container,d+f),b>=e.min_width&&b<=e.max_width&&(a._curr_profile=f)}),c.addClass(this._container,d+this._curr_profile),h>b?(c.addClass(this._container,e),c.removeClass(this._container,f)):(c.addClass(this._container,f),c.removeClass(this._container,e)),this._prev_size.width=b,this._prev_size.height=h,this.trigger("resize"))},setContainer:function(a){this._container=a,this.setSize()},currentProfile:function(){return this._curr_profile}});b.Layout=h}.call(this),function(){"use strict";function a(a){return a.hasOwnProperty("_data")}function b(a){for(var b in a._data)Object.defineProperty(a,b,{configurable:!0,get:function(b){return function(){return a.get(b)}}(b),set:function(b){return function(c){return a.set(b,c)}}(b)})}function c(b,c,d){var e=b.split("_")[0],f={set:function(a,b){},init:function(a,b){},change:function(a,b){a=a.replace("change","change:"+e),d.triggerAll(a,d.getObject())},hook_change:function(a,b){d.trigger(a,d.getObject()),d.setReady(!1)},load_start:function(a,b){a=a.replace("load_start","load_start:"+e),d.triggerAll(a,d.getObject()),d.setReady(!1)},load_error:function(a,b){a=a.replace("load_error","load_error:"+e),d.triggerAll(a,b)},ready:function(a,b){a=a.replace("ready","ready:"+e),d.trigger(a,b),d.setReady()}};if(a(c))return c.on(f),c;var g=j.Model.get(e,!0)||m;return new g(c,d,f,!0)}function d(a){return a._intervals?a._intervals:a._parent?d(a._parent):new j.Intervals}function e(a,b){var c=f(a,b);return c?c:a._parent?e(a._parent,b):void 0}function f(b,c){for(var d in b._data)if(d===c&&a(b._data[d]))return b._data[d]}function g(a){return l.isArray(a.dimensions)?a.dimensions:a._parent?g(a._parent):void l.error('ERROR: dimensions not found.\n You must specify the objects this hook will use under the dimensions attribute in the state.\n Example:\n dimensions: ["entities", "time"]')}function h(a,b,c,d){if(null==a._items||0==a._items.length)return l.warn("interpolateValue returning NULL because items array is empty"),null;var e=new Date(b.time);delete b.time;var f=a._getFilteredItems(b);if("value"==c)return f[0][a[HOOK_VALUE]];var g=d3.bisectLeft(f.map(function(a){return a.time}),e);if("property"==c&&0==g)return f[0][d];if("property"==c)return f[g-1][d];if(0==g)return f[0][d];if(g==f.length)return f[f.length-1][d];if(null==f[g][d]||null==f[g-1][d])return null;var h=(e-f[g-1].time)/(f[g].time-f[g-1].time),d=+f[g-1][d]+(f[g][d]-f[g-1][d])*h;return"[object Date]"===Object.prototype.toString.call(f[0][d])&&(d=new Date(d)),d}var i=this,j=i.Vizabi,k=j.Promise,l=j.utils;j._require("d3");var m=j.Events.extend({init:function(a,b,c,e){this._type=this._type||"model",this._id=this._id||l.uniqueId("m"),this._data={},this._parent=b,this._set=!1,this._ready=!1,this._readyOnce=!1,this._loadedOnce=!1,this._loading=[],this._intervals=d(this),this._deps={parent:[],children:[]},this._hooks={},this._items=[],this._unique={},this._filtered={},this._limits={},this._super(),c&&this.on(c),e&&this.freeze(),a&&this.set(a)},get:function(a){return a?this._data[a]:this._data},set:function(d,e,f){var g,h=[],i=this._setting,j=this;l.isPlainObject(d)?(g=d,f=e):(g={})[d]=e,i||(this._prevData=l.clone(this._data),this._changedData={}),this._setting=!0;for(var k in g){var e=g[k],m=this._data[k],n=this._prevData[k];if(!l.isPlainObject(e)||l.isArray(e)){if(m!==e||f||JSON.stringify(m)!==JSON.stringify(e)){var o="undefined"==typeof m?"init":"change";h.push(o+":"+k)}n!==e||f||JSON.stringify(n)!==JSON.stringify(e)?this._changedData[k]=e:delete this._changedData[k],this._data[k]=e}else m&&a(m)?(h.push("change:"+k),this._data[k].set(e,f)):(h.push("init:"+k),this._data[k]=c(k,e,this),this._data[k].unfreeze())}b(this),this.validate&&!i&&this.validate(),(!i||f)&&(this._set?h.length&&h.push("change"):(this._set=!0,h.push("set")),j.triggerAll(h,j.getObject()),j._setting=!1,this.isHook()||this.setReady())},getType:function(){return this._type},getSubmodels:function(){var a=[];return l.forEach(this._data,function(b){b&&"undefined"!=typeof b._id&&a.push(b)}),a},getObject:function(){var a={};for(var b in this._data)this._data[b]&&"function"==typeof this._data[b].getObject?a[b]=this._data[b].getObject():a[b]=this._data[b];return a},clear:function(){var a=this.getSubmodels();for(var b in a)a[b].clear();this.setReady(!1),this.unbindAll(),this._intervals.clearAllIntervals(),this._data={}},validate:function(){},isLoading:function(a){if(this.isHook()&&!this._loadedOnce)return!0;if(a)return-1!==this._loading.indexOf(a);if(this._loading.length>0)return!0;var b,c=this.getSubmodels();for(b=0;b<c.length;b++)if(c[b].isLoading())return!0;for(b=0;b<this._deps.children.length;b++){var d=this._deps.children[b];if(d.isLoading()||!d._ready)return!0}return!1},setLoading:function(a){this.isLoading()||this.trigger("load_start"),this._loading.push(a)},setLoadingDone:function(a){this._loading=l.without(this._loading,a),this.setReady()},setReady:function(a){if(a===!1)return this._ready=!1,void(this._parent&&this._parent.setReady&&this._parent.setReady(!1));var b=this._ready;if(this._ready=!this.isLoading()&&!this._setting&&!this._loadCall,this._ready&&b!==this._ready){this._readyOnce||(this._readyOnce=!0,this.trigger("readyOnce")),this.trigger("ready");for(var c=0;c<this._deps.parent.length;c++)this._deps.parent[c].setReady()}},load:function(){var a=this,b=this.getSubmodels(),c=this._dataModel,d=this._languageModel,e=this.getQuery(),f=new k,g=[];if(this._loadCall=!0,this.isHook()&&c&&e){this.trigger("hook_change");var h=c.getObject(),i=d?d.id:"en",m=new k,n={load_start:function(){a.setLoading("_hook_data"),j.Events.freezeAll(["load_start","resize","dom_ready"])},load_end:function(){j.Events.unfreezeAll(),a.setLoadingDone("_hook_data")}};l.timeStamp("Vizabi Model: Loading Data: "+a._id),this._dataManager.load(e,i,h,n).then(function(b){a._items=b,l.timeStamp("Vizabi Model: Data loaded: "+a._id),a._unique={},a._filtered={},a._limits={},a.afterLoad(),m.resolve()},function(b){a.trigger("load_error",e),m.reject(b)}),g.push(m)}for(var o in b)g.push(b[o].load());var p=g.length?k.all(g):new k.resolve;return p.then(function(){a.validate&&a.validate(),l.timeStamp("Vizabi Model: Model loaded: "+a._id),a._loadedOnce=!0,a._loadCall=!1,a.setReady(),f.resolve()}),f},afterLoad:function(){},resetDeps:function(){this._deps.children=[]},addDep:function(a){this._deps.children.push(a),a._deps.parent.push(this)},isHook:function(){return this.use?!0:!1},setHooks:function(){this.isHook()&&(this.dimensions=g(this),this.hookModel());var a=this.getSubmodels();l.forEach(a,function(a){a.setHooks()})},hookModel:function(){var a=this;this._dataManager=new j.Data,this._dataModel=e(this,"data"),this._languageModel=e(this,"language"),l.forEach(this.dimensions,function(b){a._hooks[b]=e(a,b),a._hooks[b].show&&a._hooks[b].on("change:show",function(b){a.load()})}),this.on("change",function(){a.load()})},getHook:function(a){return this._hooks[a]},getHookValues:function(a){var b=[];return this.use&&this.use===a&&b.push(this.which),l.forEach(this.getSubmodels(),function(c){b=l.unique(b.concat(c.getHookValues(a)))}),b},getIndicators:function(){return this.getHookValues("indicator")},getProperties:function(){return this.getHookValues("property")},getAllDimensions:function(){var a,b=[];return l.forEach(this._hooks,function(c){(a=c.getDimension())&&b.push(a)}),b},getAllFilters:function(){var a={};return l.forEach(this._hooks,function(b){a=l.extend(a,b.getFilter())}),a},getValue:function(a){var b=l.clone(a,this.getAllDimensions());return this.mapValue(this._getHookedValue(b))},getValues:function(a){var b=l.clone(a,this.getAllDimensions());return this._getHookedValues(b)},mapValue:function(a){return a},getItems:function(a){if(this.isHook()&&this._dataModel){var b=l.without(this.getAllDimensions(),"time");return this.getUnique(b).map(function(b){return a&&a.time&&(b.time=a.time),b})}return[]},getDimension:function(){return!1},getFilter:function(){return{}},getQuery:function(){var a=["property","indicator"];if(this.isHook()&&-1!==a.indexOf(this.use)){if(Object.keys(this._hooks).length<1)return l.error("Error:",this._id,"can't find any dimension"),!0;var b=this.getAllDimensions(),c=l.unique(b.concat([this.which])),d=this.getAllFilters();return{from:"data",select:c,where:d}}return!0},getScale:function(){return null==this.scale&&this.buildScale(),this.scale},buildScale:function(){if(this.isHook()){var a,b=this.scaleType||"linear";switch(this.use){case"indicator":var c=this.getLimits(this.which);a=[c.min,c.max];break;case"property":a=this.getUnique(this.which);break;case"value":default:a=[this.which]}this.scale=d3.scale[b]().domain(a)}},getLimits:function(a){if(this.isHook()){if(a||(a="time"),this._limits[a])return this._limits[a];for(var b,c,d=this._items.map(function(b){return"time"!==a?parseFloat(b[a]):new Date(b[a].toString())}),e={},f=0;f<d.length;f++){var g=d[f];("undefined"==typeof b||b>g)&&(b=g),("undefined"==typeof c||g>c)&&(c=g)}return e.min=b||0,e.max=c||0,this._limits[a]=e,e}},getUnique:function(a){if(this.isHook()){a||(a="time");var b,c=JSON.stringify(a);if(this._unique[c])return this._unique[c];if(l.isArray(a)){var d=this._items.map(function(b){return l.clone(b,a)});if(-1!==a.indexOf("time"))for(var e=0;e<d.length;e++)d[e].time=new Date(d[e].time);b=l.unique(d,function(a){return JSON.stringify(a)})}else{var d=this._items.map(function(b){return"time"!==a?b[a]:new Date(b[a])});b=l.unique(d)}return this._unique[c]=b,b}},_getHookedValue:function(a){if(!this.isHook())return void l.warn("_getHookedValue method needs the model to be hooked to data.");var b;return b="value"===this.use?this.which:this._hooks.hasOwnProperty(this.use)?this.getHook(this.use)[this.which]:h(this,a,this.use,this.which)},_getHookedValues:function(a){var b=this;if(!this.isHook())return void l.warn("_getHookedValue method needs the model to be hooked to data.");var c;if("value"===this.use)c=[this.which];else if(this._hooks.hasOwnProperty(this.use))c=[this.getHook(this.use)[this.which]];else if(a&&a.hasOwnProperty("time")){var d=new Date(a.time),e=_interpolateValue(this,a,this.use,this.which);c=l.filter(this._items,a).filter(function(a){return a.time<=d}).map(function(a){return a[b.which]}).concat(e)}else c=this._items.filter(a).map(function(a){return a[b.which]});return c},getMaxMinMean:function(a){var b=this,c={};return d3.nest().key(function(b){return a(b.time)}).entries(b._items).forEach(function(a){var d=a.values.filter(function(a){return null!=a[b.which]}).map(function(a){return+a[b.which]});c[a.key]={max:d3.max(d),min:d3.min(d),mean:d3.mean(d)}}),c},_getFilteredItems:function(a){var b=(JSON.stringify(a),JSON.stringify(a));return this._filtered[b]?this._filtered[b]:this._filtered[b]=l.filter(this._items,a)}});j.Model=m}.call(this),function(){"use strict";function a(b,d){var e=/<[a-z][\s\S]*>/i.test(b)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):f[b]=f[b]||a(c.document.getElementById(b).innerHTML);return d?e(d):e}var b="vzb-loading",c=this,d=c.Vizabi,e=d.utils,f={},g=d.Events.extend({init:function(a,b){if(this._id=this._id||e.uniqueId("c"),this._ready=!1,this._readyOnce=!1,this.name=this.name||a.name,this.template=this.template||"<div></div>",this.placeholder=this.placeholder||a.placeholder,this.template_data=this.template_data||{name:this.name},this.placeholder&&!e.isElement(this.placeholder))try{this.placeholder=b.placeholder.querySelector(this.placeholder)}catch(c){e.error("Error finding placeholder '"+this.placeholder+"' for component '"+this.name+"'")}this.parent=b||this,this.components=this.components||[],this._components_config=this.components.map(function(a){return e.clone(a)}),this._frameRate=10,this.model_expects=this.model_expects||[],this.model_binds=this.model_binds||{},this.ui=this.ui||a.ui,this._super();var d=this;this.on({readyOnce:function(){"function"==typeof d.readyOnce&&d.readyOnce()},ready:function(){"function"==typeof d.ready&&d.ready()},resize:function(){"function"==typeof d.resize&&d.resize()}})},render:function(){function a(){e.removeClass(c.placeholder,b),c.setReady()}var c=this;this.loadTemplate(),this.loadComponents(),e.forEach(this.components,function(a){a.render(),c.on("resize",function(){a.trigger("resize")})}),this.isRoot()&&this.model?(this.model.on("ready",function(){a()}),this.model.setHooks(),this.model.load()):this.model&&this.model.isLoading()?this.model.on("ready",function(){a()}):a()},setReady:function(){this._readyOnce||(this.trigger("readyOnce"),this._readyOnce=!0),this._ready=!0,this.trigger("ready")},loadTemplate:function(){var c=this.template,d=this.template_data,f=this,g="";if(this.placeholder){if(d=e.extend(d,{t:this.getTranslationFunction(!0)}),this.template)try{g=a(c,d)}catch(h){e.error("Templating error for component: '"+this.name+"' - Check if path to template is correct. E.g.: 'src/components/...'")}e.addClass(this.placeholder,b),this.placeholder.innerHTML=g,this.element=this.placeholder.children[0],this.layout&&(this.layout.setContainer(this.element),this.layout.on("resize",function(){f._ready&&e.throttle(function(){f.trigger("resize")},f._frameRate)}))}},loadComponents:function(){var a,b,c=this;this.components=[],this.model&&this.model.resetDeps(),e.forEach(this._components_config,function(f){if(!f.component)return void e.error("Error loading component: name not provided");if(b=d.Component.get(f.component)){a=e.extend(f,{name:f.component,ui:c._uiMapping(f.placeholder,f.ui)});var g=new b(a,c),h=f.model||[];g.model=c._modelMapping(g.name,h,g.model_expects,g.model_binds),g.model.unfreeze(),c.components.push(g)}})},isRoot:function(){return this.parent===this},getLayoutProfile:function(){return this.layout?this.layout.currentProfile():this.parent.getLayoutProfile()},_uiMapping:function(a,b){if(b)return new d.Model(b);if(a&&this.ui){a=a.replace(".","");var c=this.ui[a];if(c)return c}return this.ui},_modelMapping:function(a,b,c,f){function g(){var a=m.getSubmodels();for(var b in m.get())"undefined"!=typeof m[b]._id&&!function(b,c){b[c].on({set:function(d,f){d=d.replace("set","set:"+c),b.trigger(d,f);var g=!0;e.forEach(a,function(a){a._set!==!0&&(g=!1)}),g&&b.trigger("set",f)},init:function(a,d){a=a.replace("init","init:"+c),b.triggerAll(a,b.getObject())},change:function(a,d){a=a.replace("change","change:"+c),b.triggerAll(a,b.getObject())},load_start:function(a,d){a=a.replace("load_start","load_start:"+c),b.triggerAll(a,d),b.setReady(!1)},load_error:function(a,d){a=a.replace("load_error","load_error:"+c),b.triggerAll(a,d)},ready:function(a,d){a=a.replace("ready","ready:"+c),b.trigger(a,d),b.setReady()}})}(m,b)}function h(a){for(var b=a.split("."),c=i.model,d="";b.length;)d=b.shift(),c=c[d];return{name:a,model:c,type:c?c.getType():null}}var i=this,j={};if(e.isArray(b)&&e.isArray(c)){c.length!==b.length&&(e.groupCollapsed("DIFFERENCE IN NUMBER OF MODELS EXPECTED AND RECEIVED"),e.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+i.name+"'. [ADD LINK TO DOCUMENTATION]\n\nComponent: '"+i.name+"'\nSubcomponent: '"+a+"'\nNumber of Models Expected: "+c.length+"\nNumber of Models Received: "+b.length),e.groupEnd()),e.forEach(b,function(d,f){var g,k=h(d);c[f]?(g=c[f].name,c[f].type&&k.type!==c[f].type&&(e.groupCollapsed("UNEXPECTED MODEL TYPE: '"+k.type+"' instead of '"+c[f].type+"'"),e.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+i.name+"'. [ADD LINK TO DOCUMENTATION]\n\nComponent: '"+i.name+"'\nSubcomponent: '"+a+"'\nExpected Model: '"+c[f].type+"'\nReceived Model'"+k.type+"'\nModel order: "+f),e.groupEnd())):(e.groupCollapsed("UNEXPECTED MODEL: '"+b[f]+"'"),e.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+i.name+"'. [ADD LINK TO DOCUMENTATION]\n\nComponent: '"+i.name+"'\nSubcomponent: '"+a+"'\nNumber of Models Expected: "+c.length+"\nNumber of Models Received: "+b.length),e.groupEnd(),g=k.name),j[g]=k.model});var k=b.length,l=c.length;l>k&&(c.splice(0,k),e.forEach(l,function(a){j[a.name]={}}));var m=new d.Model(j,null,f,!0);return g(),m}},getTranslationFunction:function(a){var b;try{b=this.model.get("language").getTFunction()}catch(c){this.parent&&this.parent!=this&&(b=this.parent.getTranslationFunction())}return b||(b=function(a){return a}),a?this._translatedStringFunction(b):b},_translatedStringFunction:function(a){return function(b){var c=a(b);return'<span data-vzb-translate="'+b+'">'+c+"</span>"}},translateStrings:function(){var a=this.getTranslationFunction(),b=this.placeholder.querySelectorAll("[data-vzb-translate]");e.forEach(b,function(b){b.innerHTML=a(b.getAttribute("data-vzb-translate"))})},isTool:function(){return"t"===this._id[0]},readyOnce:function(){},ready:function(){},resize:function(){}});g.isComponent=function(a){return a._id&&("t"===a._id[0]||"c"===a._id[0])},d.Component=g}.call(this),function(){"use strict";function a(a,b){function c(){var e=JSON.stringify(a.getObject()),f=arguments[0]||0;this._readyOnce?b():b(this);var g=JSON.stringify(a.getObject());f>=d?i.error("Max validation loop."):e!==g&&c.call(this,[++f])}var d=10;return c}function b(a,c){for(var d in c){var e=c[d],f=a[d],g=i.isObject(e)?e._type_:null,h=i.isObject(e)?e._defs_:null,j=i.isObject(e)?e._opts_:null;g?("number"===g&&isNaN(f)?a[d]=isNaN(h)?0:h:"string"===g&&"string"!=typeof f?a[d]="string"==typeof h?h:"":"array"!==g||i.isArray(f)?"object"!==g||i.isObject(f)?("model"===g||"hook"===g)&&(i.isObject(f)||(a[d]={}),a[d]=b(a[d],h)):a[d]=i.isObject(h)?h:{}:a[d]=i.isArray(h)?h:[],i.isArray(j)&&h&&-1===j.indexOf(a[d])&&(i.warn("Vizabi options contain invalid value for '"+d+"'. Permitted values: "+JSON.stringify(j)+". Changing to default"),a[d]=h)):"undefined"==typeof f?a[d]=e:i.isObject(e)&&i.isObject(f)&&(a[d]=b(f,e))}return a}var c="vzb-loading",d="vzb-loading-error",e="vzb-placeholder",f="vzb-buttonlist-off",g=this,h=g.Vizabi,i=h.utils,j=h.Model.extend({init:function(c,d,e,f){if(this._id=i.uniqueId("tm"),this._type="tool",this.validate=a(this,f),c=c||{},d=d||{},c=b(c,d),this._super(c,null,e,!0),c.language){var g=this;this.on("change:language",function(){g.trigger("translate")})}}}),k=h.Component.extend({init:function(a,b){this._id=i.uniqueId("t"),this.layout=new h.Layout,this.template=this.template||'<div class="vzb-tool vzb-tool-'+this.name+'"><div class="vzb-tool-content"><div class="vzb-tool-stage"><div class="vzb-tool-viz"></div><div class="vzb-tool-timeslider"></div></div><div class="vzb-tool-buttonlist"></div></div></div>',this.model_binds=this.model_binds||{},this.default_options=this.default_options||{};var c=this.validate.bind(this),d=this,e=i.merge({change:function(a,b){d._ready&&(d.model.validate(),d.triggerAll(a,b))},translate:function(a,b){d._ready&&d.model.load().then(function(){d.model.validate(),d.translateStrings()})},load_start:function(){d.beforeLoading()},load_error:function(){d.errorLoading()},ready:function(a){d._ready&&d.afterLoading()}},this.model_binds);b=b||{},this.model=new j(b,this.default_options,e,c),this.model.unfreeze(),this.ui=this.model.ui,this._super({name:this.name||this._id,placeholder:a},this),this._bindEvents(),
this.render(),this._setUIOptions()},_bindEvents:function(){this.model.bind&&this.on(this.model.bind.get())},setOptions:function(a,b,c){b?this.model.reset(a):this.model.set(a),this._setUIOptions()},getOptions:function(){return this.model.getObject()||{}},beforeLoading:function(){i.hasClass(this.placeholder,c)||i.addClass(this.placeholder,c)},afterLoading:function(){i.removeClass(this.placeholder,c)},errorLoading:function(){i.addClass(this.placeholder,d)},validate:function(){},_setUIOptions:function(){i.addClass(this.placeholder,e),this.ui&&this.ui.buttons&&this.ui.buttons.length?i.removeClass(this.element,f):i.addClass(this.element,f)}});k.isTool=function(a){return a._id&&"t"===a._id[0]},h.Tool=k}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/bubble-size/bubble-size.html"),b.innerHTML='<div class="vzb-bs-holder"> <input type="range" id="vzb-bs-slider" class="vzb-bs-slider" step="1"> </div>',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/more-options/more-options.html"),b.innerHTML='<div class="vzb-dialog-modal"> <div class="vzb-dialog-title"> <%=t ( "buttons/more_options") %> </div> <div class="vzb-dialog-content"> <p>Opacity of non-selected</p> <div class="vzb-dialog-bubble-opacity"></div> <div class = "vzb-dialog-br"></div> <p>X axis</p> <div class="vzb-xaxis-container"></div> <p>Y axis</p> <div class="vzb-yaxis-container"></div> <div class="vzb-axes-options"></div> <div class = "vzb-dialog-br"></div> <p>Size</p> <div class="vzb-saxis-container"></div> <div class="vzb-dialog-bubble-size"></div> <div class = "vzb-dialog-br"></div> <p>Colors</p> <div class="vzb-caxis-container"></div> <div class="vzb-clegend-container"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div>',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/simple-checkbox/simple-checkbox.html"),b.innerHTML='<span class="vzb-sc-holder vzb-dialog-checkbox"> <input type="checkbox"><label></label> </span> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/timeslider/timeslider.html"),b.innerHTML='<div class="vzb-timeslider"> <div class="vzb-ts-slider-wrapper"> <svg class="vzb-ts-slider"> <g> <g class="vzb-ts-slider-axis"></g> <g class="vzb-ts-slider-slide"> <circle class="vzb-ts-slider-handle"></circle> <text class="vzb-ts-slider-value"></text> </g> </g> </svg> </div>  <div class="vzb-ts-btns"> <button class="vzb-ts-btn-play vzb-ts-btn"> <svg class="vzb-icon vzb-icon-play" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1576 927l-1328 738q-23 13-39.5 3t-16.5-36v-1472q0-26 16.5-36t39.5 3l1328 738q23 13 23 31t-23 31z"/></svg> </button> <button class="vzb-ts-btn-pause vzb-ts-btn"> <svg class="vzb-icon vzb-icon-pause" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1664 192v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45zm-896 0v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45z"/></svg> </button> </div> </div>',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/barchart/barchart.html"),b.innerHTML=' <svg class="vzb-barchart"> <g class="vzb-bc-graph"> <g class="vzb-bc-bars"></g> <g class="vzb-bc-bar-labels"></g> <text class="vzb-bc-axis-y-title"></text> <g class="vzb-bc-axis-x"></g> <g class="vzb-bc-axis-y"></g> <g class="vzb-bc-axis-labels">  </g> </g> </svg>',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/bubblechart/bubblechart.html"),b.innerHTML=' <div class="vzb-bubble-chart"> <svg class="vzb-bubble-chart-svg"> <g class="vzb-bc-graph"> <text class="vzb-bc-year"></text> <svg class="vzb-bc-axis-x"><g></g></svg> <svg class="vzb-bc-axis-y"><g></g></svg> <line class="vzb-bc-projection-x"></line> <line class="vzb-bc-projection-y"></line> <svg class="vzb-bc-bubbles-crop"> <g class="vzb-bc-trails"></g> <g class="vzb-bc-bubbles"></g> <g class="vzb-bc-labels"></g> </svg> <g class="vzb-bc-axis-y-title"></g> <g class="vzb-bc-axis-x-title"></g> <g class="vzb-bc-axis-s-title"></g> <g class="vzb-bc-axis-c-title"></g> <rect class="vzb-bc-zoomRect"></rect> </g> <filter id="vzb-bc-blur-effect"> <feGaussianBlur stdDeviation="2" /> </filter> </svg>  <div class="vzb-tooltip vzb-hidden"></div> </div>',a.document.body.appendChild(b)}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils;if(b._require("d3")){var c;b.Component.extend("gapminder-bubble-size",{init:function(a,b){this.template="components/_gapminder/bubble-size/bubble-size",this.model_expects=[{name:"size",type:"size"}],this._super(a,b)},readyOnce:function(){var a=this.model.size.max,b=this;this.element=d3.select(this.element),c=this.element.select("#vzb-bs-indicator"),slider=this.element.selectAll("#vzb-bs-slider"),slider.attr("min",0).attr("max",1).attr("step",.01).attr("value",a).on("input",function(){b.slideHandler()})},modelReady:function(){c.text(this.model.size.max)},resize:function(){},slideHandler:function(){this._setValue(+d3.event.target.value)},_setValue:function(a){var b=50,c=new Date;null!=this._updTime&&c-this._updTime<b||(this._updTime=c,this.model.size.max=a)}})}}.call(this),function(){"use strict";function a(a){a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}function b(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}var c=this,d=c.Vizabi,e=(d.Promise,d.utils);if(d._require("d3")){var f="vzb-active",g="vzb-unavailable",h="vzb-force-fullscreen";d.Component.extend("gapminder-buttonlist",{init:function(a,b){var c=this;this.name="buttonlist",this.template='<div class="vzb-buttonlist"></div>',this.model_expects=[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this._available_buttons={find:{title:"buttons/find",icon:"search",dialog:!0},"more-options":{title:"buttons/more_options",icon:"gear",dialog:!0},colors:{title:"buttons/colors",icon:"paint-brush",dialog:!0},size:{title:"buttons/size",icon:"circle",dialog:!0},fullscreen:{title:"buttons/expand",icon:"expand",dialog:!1,func:this.toggleFullScreen.bind(this)},trails:{title:"buttons/trails",icon:"trails",dialog:!1,func:this.toggleBubbleTrails.bind(this)},lock:{title:"buttons/lock",icon:"lock",dialog:!1,func:this.toggleBubbleLock.bind(this)},axes:{title:"buttons/axes",icon:"axes",dialog:!0},_default:{title:"Button",icon:"asterisk",dialog:!1}},this._active_comp=!1,this.model_binds={"change:state:entities:select":function(){0===c.model.state.entities.select.length&&(c.model.state.time.lockNonSelected=0)}},this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element)},ready:function(){var a=this;this.model.ui.buttons&&this._addButtons();var b=this.element.selectAll(".vzb-buttonlist-btn");b.on("click",function(){var b=d3.select(this),c=b.attr("data-btn"),d=b.attr("class"),e=a._available_buttons[c];e&&e.dialog?-1!==d.indexOf(f)?a.closeDialog(c):a.openDialog(c):e.func&&e.func(c)});var c=this.element.selectAll("[data-click='closeDialog']");c.on("click",function(){a.closeAllDialogs()}),this._prev_body_overflow=document.body.style.overflow},startup:function(){var a=this;button_list.forEach(function(b){switch(b){case"trails":a.setBubbleTrails(b);break;case"lock":a.setBubbleLock(b)}})},_addButtons:function(){this._components_config=[];var a=this.model.ui.buttons,b=[];if(a.length){for(var c=0;c<a.length;c++){var d=a[c],f=this._available_buttons[d];if(f&&f.dialog){var g=this._components_config;g.push({component:"gapminder-buttonlist-"+d,placeholder:'.vzb-buttonlist-dialog[data-btn="'+d+'"]',model:["state","ui","language"]}),f.component=g.length-1}var h=f?d:"_default",i=this._available_buttons[h];i.id=d,i.icon=this._icons[i.icon],b.push(i)}var j=this.getTranslationFunction(!0);this.element.selectAll("button").data(b).enter().append("button").attr("class","vzb-buttonlist-btn").attr("data-btn",function(a){return a.id}).html(function(a){return"<span class='vzb-buttonlist-btn-icon fa'>"+a.icon+"</span><span class='vzb-buttonlist-btn-title'>"+j(a.title)+"</span>"}),this.element.selectAll("div").data(b).enter().append("div").attr("class","vzb-buttonlist-dialog").attr("data-btn",function(a){return a.id});this.loadComponents();var k=this;e.forEach(this.components,function(a){a.render(),k.on("resize",function(){a.trigger("resize")})})}},resize:function(){},openDialog:function(a){this.closeAllDialogs();var b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.element.selectAll(".vzb-buttonlist-dialog[data-btn='"+a+"']");b.classed(f,!0),c.classed(f,!0),this._active_comp=this.components[this._available_buttons[a].component],this._active_comp.open()},closeDialog:function(a){var b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.element.selectAll(".vzb-buttonlist-dialog[data-btn='"+a+"']");b.classed(f,!1),c.classed(f,!1),this._active_comp&&this._active_comp.close(),this._active_comp=!1},closeAllDialogs:function(){var a=this.element.selectAll(".vzb-buttonlist-btn"),b=this.element.selectAll(".vzb-buttonlist-dialog");a.classed(f,!1),b.classed(f,!1),this._active_comp&&this._active_comp.close(),this._active_comp=!1},toggleBubbleTrails:function(a){this.model.state.time.trails=!this.model.state.time.trails,this.setBubbleTrails(a)},setBubbleTrails:function(a,b){var c=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']");c.classed(f,this.model.state.time.trails)},toggleBubbleLock:function(a){if(0!=this.model.state.entities.select.length){var b=d3.time.format(this.model.state.time.formatInput),c=this.model.state.time.lockNonSelected;c=c?0:b(this.model.state.time.value),this.model.state.time.lockNonSelected=c,this.setBubbleLock(a)}},setBubbleLock:function(a){var b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.model.language.getTFunction(),d=this.model.state.time.lockNonSelected;b.classed(g,0==this.model.state.entities.select.length),b.classed(f,d),b.select(".vzb-buttonlist-btn-title").text(d?d:c("buttons/lock")),b.select(".vzb-buttonlist-btn-icon").html(this._icons[d?"lock":"unlock"])},toggleFullScreen:function(d){for(var g=this,i=g.placeholder,j=!1,k=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+d+"']"),l=!this.model.ui.fullscreen,m=l?"hidden":this._prev_body_overflow;!(j=e.hasClass(i,"vzb-placeholder"));)g=this.parent,i=g.placeholder;l?a(i):b(),e.classed(i,h,l),this.model.ui.fullscreen=l;var n=this.model.language.getTFunction();k.classed(f,l),k.select(".vzb-buttonlist-btn-icon").html(this._icons[l?"unexpand":"expand"]),k.select(".vzb-buttonlist-btn-title").text(n("buttons/"+(l?"unexpand":"expand"))),document.body.style.overflow=m,function(){event=c.document.createEvent("HTMLEvents"),event.initEvent("resize",!0,!0),event.eventName="resize",c.dispatchEvent(event)}()},_icons:{"paint-brush":'<svg class="vzb-icon vzb-icon-paint-brush" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1615 0q70 0 122.5 46.5t52.5 116.5q0 63-45 151-332 629-465 752-97 91-218 91-126 0-216.5-92.5t-90.5-219.5q0-128 92-212l638-579q59-54 130-54zm-909 1034q39 76 106.5 130t150.5 76l1 71q4 213-129.5 347t-348.5 134q-123 0-218-46.5t-152.5-127.5-86.5-183-29-220q7 5 41 30t62 44.5 59 36.5 46 17q41 0 55-37 25-66 57.5-112.5t69.5-76 88-47.5 103-25.5 125-10.5z"/></svg>',search:'<svg class="vzb-icon vzb-icon-search" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1216 832q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 52-38 90t-90 38q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/></svg>',circle:'<svg class="vzb-icon vzb-icon-circle" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1664 896q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"/></svg>',expand:'<svg class="vzb-icon vzb-icon-expand" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M883 1056q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23zm781-864v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45z"/></svg>',asterisk:'<svg class="vzb-icon vzb-icon-asterisk" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1546 1050q46 26 59.5 77.5t-12.5 97.5l-64 110q-26 46-77.5 59.5t-97.5-12.5l-266-153v307q0 52-38 90t-90 38h-128q-52 0-90-38t-38-90v-307l-266 153q-46 26-97.5 12.5t-77.5-59.5l-64-110q-26-46-12.5-97.5t59.5-77.5l266-154-266-154q-46-26-59.5-77.5t12.5-97.5l64-110q26-46 77.5-59.5t97.5 12.5l266 153v-307q0-52 38-90t90-38h128q52 0 90 38t38 90v307l266-153q46-26 97.5-12.5t77.5 59.5l64 110q26 46 12.5 97.5t-59.5 77.5l-266 154z"/></svg>',trails:'<svg class="vzb-icon vzb-icon-trails" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1344 1024q133 0 226.5 93.5t93.5 226.5-93.5 226.5-226.5 93.5-226.5-93.5-93.5-226.5q0-12 2-34l-360-180q-92 86-218 86-133 0-226.5-93.5t-93.5-226.5 93.5-226.5 226.5-93.5q126 0 218 86l360-180q-2-22-2-34 0-133 93.5-226.5t226.5-93.5 226.5 93.5 93.5 226.5-93.5 226.5-226.5 93.5q-126 0-218-86l-360 180q2 22 2 34t-2 34l360 180q92-86 218-86z"/></svg>',lock:'<svg class="vzb-icon vzb-icon-lock" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M640 768h512v-192q0-106-75-181t-181-75-181 75-75 181v192zm832 96v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-192q0-184 132-316t316-132 316 132 132 316v192h32q40 0 68 28t28 68z"/></svg>',unlock:'<svg class="vzb-icon vzb-icon-unlock" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1376 768q40 0 68 28t28 68v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-320q0-185 131.5-316.5t316.5-131.5 316.5 131.5 131.5 316.5q0 26-19 45t-45 19h-64q-26 0-45-19t-19-45q0-106-75-181t-181-75-181 75-75 181v320h736z"/></svg>',unexpand:'<svg class="vzb-icon vzb-icon-unexpand" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 960v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45zm755-672q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23z"/></svg>',axes:'<svg class="vzb-icon vzb-icon-axes" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><path d="M430.25,379.655l-75.982-43.869v59.771H120.73V151.966h59.774l-43.869-75.983L92.767,0L48.898,75.983L5.029,151.966h59.775 v271.557c0,15.443,12.52,27.965,27.963,27.965h261.5v59.773l75.982-43.869l75.982-43.867L430.25,379.655z"/></svg>',gear:'<svg class="vzb-icon vzb-icon-gear" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1152 896q0-106-75-181t-181-75-181 75-75 181 75 181 181 75 181-75 75-181zm512-109v222q0 12-8 23t-20 13l-185 28q-19 54-39 91 35 50 107 138 10 12 10 25t-9 23q-27 37-99 108t-94 71q-12 0-26-9l-138-108q-44 23-91 38-16 136-29 186-7 28-36 28h-222q-14 0-24.5-8.5t-11.5-21.5l-28-184q-49-16-90-37l-141 107q-10 9-25 9-14 0-25-11-126-114-165-168-7-10-7-23 0-12 8-23 15-21 51-66.5t54-70.5q-27-50-41-99l-183-27q-13-2-21-12.5t-8-23.5v-222q0-12 8-23t19-13l186-28q14-46 39-92-40-57-107-138-10-12-10-24 0-10 9-23 26-36 98.5-107.5t94.5-71.5q13 0 26 10l138 107q44-23 91-38 16-136 29-186 7-28 36-28h222q14 0 24.5 8.5t11.5 21.5l28 184q49 16 90 37l142-107q9-9 24-9 13 0 25 10 129 119 165 170 7 8 7 22 0 12-8 23-15 21-51 66.5t-54 70.5q26 50 41 98l183 28q13 2 21 12.5t8 23.5z"/></svg>'}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b._require("d3")&&b.Component.extend("gapminder-buttonlist-dialog",{init:function(a,b){this.name=this.name||"",this.model_expects=this.model_expects||[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this.template="src/components/_gapminder/buttonlist/dialogs/"+this.name+"/"+this.name+".html",this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element),close_buttons=this.element.selectAll("[data-click='closeDialog']");var a=this;close_buttons.on("click",function(){a.parent.closeAllDialogs()})},open:function(){},close:function(){}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.Component.get("gapminder-buttonlist-dialog");b.Component.register("gapminder-buttonlist-more-options",c.extend({init:function(a,b){this.name="more-options";this.components=[{component:"gapminder-indicator-picker",placeholder:".vzb-xaxis-container",model:["state.marker.axis_x","language"]},{component:"gapminder-indicator-picker",placeholder:".vzb-yaxis-container",model:["state.marker.axis_y","language"]},{component:"gapminder-simple-checkbox",placeholder:".vzb-axes-options",model:["state","language"],submodel:"time",checkbox:"adaptMinMaxZoom"},{component:"gapminder-indicator-picker",placeholder:".vzb-caxis-container",model:["state.marker.color","language"]},{component:"gapminder-color-legend",placeholder:".vzb-clegend-container",model:["state.marker.color","language"]},{component:"gapminder-bubble-opacity",placeholder:".vzb-dialog-bubble-opacity",model:["state.entities"]}],this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element),this.opacity_nonselected=this.element.select(".vzb-dialog-bubble-opacity")}}))}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d="value",e="scaleType";if(b._require("d3")){var f={"geo.region":{use:"property",unit:"",scales:["ordinal"]},geo:{use:"property",unit:"",scales:["ordinal"]},time:{use:"indicator",unit:"year",scales:["time"]},lex:{use:"indicator",unit:"years",scales:["linear"]},gdp_per_cap:{use:"indicator",unit:"$/year/person",scales:["log","linear"]},pop:{use:"indicator",unit:"",scales:["linear","log"]},_default:{use:"value",unit:"",scales:["linear","log"]}};b.Component.extend("gapminder-indicator-picker",{init:function(a,b){this.template='<span class="vzb-ip-holder"><select class="vzb-ip-indicator"></select><select class="vzb-ip-scaletype"></select></span>';var d=this;this.model_expects=[{name:"axis"},{name:"language",type:"language"}],this.model_binds={"change:axis":function(a){d.updateView()},"change:language":function(a){d.updateView()}},this._super(a,b),this.ui=c.extend({selectIndicator:!0,selectScaletype:!0},this.ui)},ready:function(){this.updateView()},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.el_select_indicator=this.element.select(".vzb-ip-indicator"),this.el_select_scaletype=this.element.select(".vzb-ip-scaletype"),this.el_select_indicator.on("change",function(){a._setModel(d,this.value)}),this.el_select_scaletype.on("change",function(){a._setModel(e,this.value)})},updateView:function(){var a=this;this.translator=this.model.language.getTFunction();var b="_default",c={};c[d]=Object.keys(f),c[d].indexOf(this.model.axis[d])>-1&&(b=this.model.axis[d]),c[e]=f[b].scales;var g=this.el_select_indicator.selectAll("option").data(c[d],function(a){return a}),h=this.el_select_scaletype.selectAll("option").data(c[e],function(a){return a});g.exit().remove(),h.exit().remove(),g.enter().append("option").attr("value",function(a){return a}),h.enter().append("option").attr("value",function(a){return a}),g.text(function(b){return a.translator("indicator/"+b)}),h.text(function(b){return a.translator("scaletype/"+b)}),this.el_select_indicator[0][0].value=this.model.axis[d],this.el_select_scaletype[0][0].value=this.model.axis[e],this.el_select_indicator.style("display",this.ui.selectIndicator?"auto":"none").attr("disabled",c[d].length<=1?"true":null),this.el_select_scaletype.style("display",this.ui.selectScaletype?"auto":"none").attr("disabled",c[e].length<=1?"true":null)},_setModel:function(a,b){var c=this.model.axis;c[a]=b,a==d&&(c.use=f[b].use,c.unit=f[b].unit,-1==f[b].scales.indexOf(c.scaleType)&&(c.scaleType=f[b].scales[0]))}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils;b._require("d3")&&b.Component.extend("gapminder-simple-checkbox",{init:function(a,b){this.template='<span class="vzb-sc-holder vzb-dialog-checkbox"><input type="checkbox"><label></label></span>';var c=this;this.checkbox=a.checkbox,this.submodel=a.submodel,this.model_expects=[{name:"mdl"},{name:"language",type:"language"}],this.model_binds={"change:language":function(a){c.updateView()}},this.model_binds["change:mdl:"+this.submodel+":"+this.checkbox]=function(){c.updateView()},this._super(a,b)},ready:function(){this.updateView()},readyOnce:function(){var a=this;this.element=d3.select(this.element);var b="-check-"+1e3*Math.random();this.labelEl=this.element.select("label").attr("for",b),this.checkEl=this.element.select("input").attr("id",b).on("change",function(){a._setModel(d3.select(this).property("checked"))})},updateView:function(){this.translator=this.model.language.getTFunction(),this.labelEl.text(this.translator("check/"+this.checkbox)),this.checkEl.property("checked",!!this.model.mdl[this.submodel][this.checkbox])},_setModel:function(a){this.model.mdl[this.submodel][this.checkbox]=a}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=(b.Promise,b.utils);if(b._require("d3")){var d="vzb-playing",e="vzb-ts-hide-play-button",f="vzb-ts-dragging",g="vzb-ts-axis-aligned",h="vzb-ts-show-value",i="vzb-ts-show-value-when-drag-play",j={year:d3.time.format("%Y"),month:d3.time.format("%b"),week:d3.time.format("week %U"),day:d3.time.format("%d/%m/%Y"),hour:d3.time.format("%d/%m/%Y %H"),minute:d3.time.format("%d/%m/%Y %H:%M"),second:d3.time.format("%d/%m/%Y %H:%M:%S")},k={small:{margin:{top:9,right:15,bottom:10,left:15},radius:8,label_spacing:10},medium:{margin:{top:9,right:15,bottom:10,left:15},radius:10,label_spacing:12},large:{margin:{top:9,right:15,bottom:10,left:15},radius:11,label_spacing:14}};b.Component.extend("gapminder-timeslider",{init:function(a,b){this.template=this.template||"src/components/_gapminder/timeslider/timeslider.html",this.model_expects=[{name:"time",type:"time"}];var d=this;this.model_binds={"change:time":function(a,b){-1!==["change:time:start","change:time:end"].indexOf(a)&&d.changeLimits(),d.changeTime();var c=d.model.time.playing;d._setHandle(c)}},this.ui=c.extend({show_limits:!1,show_value:!1,show_value_when_drag_play:!0,show_button:!0,class_axis_aligned:!1},a.ui,this.ui),this._super(a,b),this.width=0,this.height=0},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.slider_outer=this.element.select(".vzb-ts-slider"),this.slider=this.slider_outer.select("g"),this.axis=this.element.select(".vzb-ts-slider-axis"),this.slide=this.element.select(".vzb-ts-slider-slide"),this.handle=this.slide.select(".vzb-ts-slider-handle"),this.valueText=this.slide.select(".vzb-ts-slider-value"),this.xScale=d3.time.scale().clamp(!0),this.xAxis=d3.svg.axis().orient("bottom").tickSize(0),this.valueText.attr("text-anchor","middle").attr("dy","-1em");var b=a._getBrushed(),d=a._getBrushedEnd();this.brush=d3.svg.brush().x(this.xScale).extent([0,0]).on("brush",function(){c.throttle(b.bind(this),10)}).on("brushend",function(){c.throttle(d.bind(this),10)}),this.slide.call(this.brush),this.slide.selectAll(".extent,.resize").remove();var a=this},ready:function(){var a=this.element.select(".vzb-ts-btn-play"),b=this.element.select(".vzb-ts-btn-pause"),c=this;a.on("click",function(){c.model.time.play()}),b.on("click",function(){c.model.time.pause()}),this.format=j[this.model.time.unit],this.changeLimits(),this.changeTime(),this.resize(),this._setHandle(this.model.time.playing)},changeLimits:function(){var a=this.model.time.start,b=this.model.time.end;this.xScale.domain([a,b]),this.xAxis.tickValues([a,b]).tickFormat(this.format)},changeTime:function(){this.ui.format=this.model.time.unit;this.model.time.value;this._optionClasses()},resize:function(){this.model.time.pause(),this.profile=k[this.getLayoutProfile()];var a=parseInt(this.slider_outer.style("width"),10),b=parseInt(this.slider_outer.style("height"),10);this.width=a-this.profile.margin.left-this.profile.margin.right,this.height=b-this.profile.margin.bottom-this.profile.margin.top;this.slider.attr("transform","translate("+this.profile.margin.left+","+this.profile.margin.top+")"),(this.xScale.range()[1]=1)&&this.xScale.range([0,this.width]),this.xAxis=this.xAxis.scale(this.xScale).tickPadding(this.profile.label_spacing),this.axis.attr("transform","translate(0,"+this.height/2+")").call(this.xAxis),this.slide.select(".background").attr("height",this.height),this.handle.attr("transform","translate(0,"+this.height/2+")").attr("r",this.profile.radius),this._setHandle()},getSetProfile:function(a){return arguments.length?(k=a,this):k},getSetScaleRangeMax:function(a){return arguments.length?(this.xScale.range([0,a]),this):this.xScale.range()[1]},_getBrushed:function(){var a=this;return function(){a.model.time.pause(),a._blockUpdate||(a._optionClasses(),a._blockUpdate=!0,a.element.classed(f,!0));var b=a.brush.extent()[0];d3.event.sourceEvent&&(b=a.xScale.invert(d3.mouse(this)[0])),b-a.model.time.value!==0&&a._setTime(b),a._setHandle(a.model.time.playing)}},_getBrushedEnd:function(){var a=this;return function(){a._blockUpdate=!1,a.model.time.pause(),a.element.classed(f,!1),a.model.time.snap()}},_setHandle:function(a){var b=this.model.time.value;this.slide.call(this.brush.extent([b,b])),this.valueText.text(this.format(b));var c=this.model.time.speed,d=this.handle.attr("cx"),e=this.xScale(b);a?(this.handle.attr("cx",d).transition().duration(c).ease("linear").attr("cx",e),this.valueText.attr("transform","translate("+d+","+this.height/2+")").transition().duration(c).ease("linear").attr("transform","translate("+e+","+this.height/2+")")):(this.handle.attr("cx",e),this.valueText.attr("transform","translate("+e+","+this.height/2+")"))},_setTime:function(a){var b=this,c=50,d=new Date;null!=this._updTime&&d-this._updTime<c||(this._updTime=d,b.model.time.value=a)},_optionClasses:function(){var a=this.ui.show_limits,b=this.ui.show_value,c=this.ui.show_value_when_drag_play,f=this.ui.axis_aligned,j=this.ui.show_button&&this.model.time.playable;a||this.xAxis.tickValues([]).ticks(0),this.element.classed(e,!j),this.element.classed(d,this.model.time.playing),this.element.classed(h,b),this.element.classed(i,c),this.element.classed(g,f)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){var d={year:d3.time.format("%Y"),month:d3.time.format("%Y-%m"),week:d3.time.format("%Y-W%W"),day:d3.time.format("%Y-%m-%d"),hour:d3.time.format("%Y-%m-%d %H"),minute:d3.time.format("%Y-%m-%d %H:%M"),second:d3.time.format("%Y-%m-%d %H:%M:%S")};b.Model.extend("axis",{init:function(a,b,d){this._type="axis",a=c.extend({use:"value",unit:"",which:void 0},a),this._super(a,b,d)},validate:function(){var a=["log","linear","time","pow"];(!this.scaleType||"indicator"===this.use&&-1===a.indexOf(this.scaleType))&&(this.scaleType="linear"),"indicator"!==this.use&&"ordinal"!==this.scaleType&&(this.scaleType="ordinal"),(this.value_1!=this.which||this.scaleType_1!=this.scaleType)&&(this.scale=null),this.value_1=this.which,this.scaleType_1=this.scaleType},tickFormatter:function(a){var b=a;return c.isDate(a)?b=d.year(a):"indicator"==this.use&&(b=parseFloat(a)),b},buildScale:function(){var a,b=this.scaleType||"linear";if("time"==this.which){var c=this.getLimits(this.which);return void(this.scale=d3.time.scale().domain([c.min,c.max]))}switch(this.use){case"indicator":var c=this.getLimits(this.which),d=(c.max-c.min)/20;a=[c.min-d,c.max+d],"log"==b&&(a=[c.min-c.min/4,c.max+c.max/4]);break;case"property":a=this.getUnique(this.which);break;case"value":default:a=[this.which]}this.scale=d3.scale[b]().domain(a)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){var d={"geo.region":{asi:"#FF5872",eur:"#FFE700",ame:"#7FEB00",afr:"#00D5E9",_default:"#ffb600"},geo:{color1:"#F77481",color2:"#E1CE00",color3:"#B4DE79",color4:"#62CCE3"},time:{0:"#F77481",1:"#E1CE00",2:"#B4DE79"},lex:{0:"#F77481",1:"#E1CE00",2:"#B4DE79"},gdp_per_cap:{0:"#F77481",1:"#E1CE00",2:"#B4DE79",3:"#62CCE3"},pop:{0:"#F77481",1:"#E1CE00",2:"#B4DE79"},_default:{_default:"#fa5ed6"}},e={"geo.region":!1};b.Model.extend("color",{init:function(a,b,d){this._type="color",a=c.extend({use:"value",unit:"",palette:null,which:void 0},a),this._super(a,b,d),this.firstLoad=!0,this.hasDefaultColor=!1},getPalettes:function(){return d},isUserSelectable:function(a){return null==e[a]?!0:e[a]},validate:function(){var a=["log","genericLog","linear","time","pow"];(!this.scaleType||"indicator"===this.use&&-1===a.indexOf(this.scaleType))&&(this.scaleType="linear"),"indicator"!==this.use&&"ordinal"!==this.scaleType&&(this.scaleType="ordinal"),(null==this.palette||!this.firstLoad&&this.value_1!=this.which||!this.firstLoad&&this.scaleType_1!=this.scaleType)&&(this.set("palette",null,!1),this.scale=null,d[this.which]?this.palette=c.clone(d[this.which]):"value"==this.use?this.palette={_default:this.which}:this.palette=c.clone(d._default)),this.value_1=this.which,this.scaleType_1=this.scaleType,this.firstLoad=!1},setColor:function(a,b){var d=this.palette.getObject();d[b]=a,this.scale.range(c.values(d)),this.palette[b]=a},mapValue:function(a){return null!=this.scale&&"property"==this.use&&this.hasDefaultColor&&-1==this.scale.domain().indexOf(a)&&(a="_default"),this._super(a)},buildScale:function(){var a=this,b=Object.keys(a.palette.getObject()),d=c.values(a.palette.getObject());if(this.hasDefaultColor=b.indexOf("_default")>-1,"time"==this.which){var e=this.getLimits(this.which);return void(this.scale=d3.time.scale().domain([e.min,e.max]).range(d))}switch(this.use){case"indicator":var e=this.getLimits(this.which),f=(e.max-e.min)/(d.length-1);if(b=d3.range(e.min,e.max,f).concat(e.max),"log"==this.scaleType){var g=d3.scale.log().domain([e.min,e.max]).range([e.min,e.max]);b=b.map(function(a){return g.invert(a)})}return void(this.scale=d3.scale[this.scaleType]().domain(b).range(d).interpolate(d3.interpolateRgb));default:return void(this.scale=d3.scale.ordinal().domain(b).range(d))}}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("data",{init:function(a,b,d){this._type="data",a=c.extend({reader:"local-json"},a),this._super(a,b,d)}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("entities",{init:function(a,b,d){this._type="entities",a=c.extend({show:{},select:[],brush:[],opacityNonSelected:.3},a),this._visible=[],this._super(a,b,d)},validate:function(a){var b=this.getDimension(),c=this._visible.map(function(a){return a[b]});this.select=this.select.filter(function(a){return-1!==c.indexOf(a[b])}),this.brush=this.brush.filter(function(a){return-1!==c.indexOf(a[b])})},getDimension:function(){return this.show.dim;
},getFilter:function(){return this.show.filter.getObject()},getSelected:function(){var a=this.getDimension();return this.select.map(function(b){return b[a]})},selectEntity:function(a,b){var c=this.getDimension(),d=a[c];if(this.isSelected(a))this.select=this.select.filter(function(a){return a[c]!==d});else{var e={};e[c]=d,e.labelOffset=[0,0],b&&(e.trailStartTime=b(a.time)),this.select=this.select.concat(e)}},setLabelOffset:function(a,b){var d=this.getDimension(),e=a[d];c.find(this.select,function(a){return a[d]===e}).labelOffset=b,this.set("select",this.select,!0)},isSelected:function(a){var b=this.getDimension(),c=a[this.getDimension()],d=this.select.map(function(a){return a[b]});return-1!==d.indexOf(c)},clearSelected:function(){this.select=[]},highlightEntity:function(a,b){var c=this.getDimension(),d=a[c];if(!this.isHighlighted(a)){var e={};e[c]=d,b&&(e.trailStartTime=b(a.time)),this.brush=this.brush.concat(e)}},unhighlightEntity:function(a,b){var c=this.getDimension(),d=a[c];this.isHighlighted(a)&&(this.brush=this.brush.filter(function(a){return a[c]!==d}))},isHighlighted:function(a){var b=this.getDimension(),c=a[this.getDimension()],d=this.brush.map(function(a){return a[b]});return-1!==d.indexOf(c)},clearHighlighted:function(){this.brush=[]}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("language",{init:function(a,b,d){this._type="language",a=c.extend({id:"en",strings:{}},a),this._super(a,b,d)},getUIString:function(a,b,c){return b=b||this.id,c=c||this.strings,c&&c.hasOwnProperty(b)&&c[b].hasOwnProperty(a)?c[b][a]:a},getTFunction:function(){var a=this.id,b=this.strings,c=this;return function(d){return c.getUIString(d,a,b)}}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&b.Model.extend("size",{init:function(a,b,d){this._type="size",a=c.extend({use:"value",unit:"",which:void 0},a),this._super(a,b,d)},validate:function(){("undefined"==typeof this.min||this.min<0)&&(this.min=0),("undefined"==typeof this.max||this.max>1)&&(this.max=1),this.min>this.max&&(this.min=this.max),"value"===this.use&&this.which>this.max?this.which=this.max:"value"===this.use&&this.which<this.min&&(this.which=this.min),this.scaleType||(this.scaleType="linear"),"property"===this.use&&(this.scaleType="ordinal"),(this.value_1!=this.which||this.scaleType_1!=this.scaleType)&&(this.scale=null),this.value_1=this.which,this.scaleType_1=this.scaleType},buildScale:function(){"value"===this.use&&(this.scale=d3.scale.linear().domain([0,1])),this._super()}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){var d={year:d3.time.format("%Y"),month:d3.time.format("%Y-%m"),week:d3.time.format("%Y-W%W"),day:d3.time.format("%Y-%m-%d"),hour:d3.time.format("%Y-%m-%d %H"),minute:d3.time.format("%Y-%m-%d %H:%M"),second:d3.time.format("%Y-%m-%d %H:%M:%S")},e=Object.keys(d),f=c.values(d);b.Model.extend("time",{init:function(a,b,d){this._type="time",a=c.extend({value:"1800",start:"1800",end:"2014",playable:!0,playing:!1,loop:!1,round:!0,speed:500,unit:"year",format:"%Y",step:1,adaptMinMaxZoom:!1},a),this._super(a,b,d);var e=this;this._playing_now=!1,this.on({"change:playing":function(){e.playing===!0?e._startPlaying():e._stopPlaying()},set:function(){e.playing===!0&&e.set("playing",!0,!0),this.snap("start"),this.snap("end"),this.snap("value")}})},_formatToDates:function(){for(var a=["value","start","end"],b=0;b<a.length;b++){var d=a[b];if(!c.isDate(this[d]))for(var e=0;e<f.length;e++){var g=f[e],h=g.parse(this[d].toString());if(c.isDate(h)){this.set(d,h);break}}}},validate:function(){-1===e.indexOf(this.unit)&&(this.unit="year"),this.step<1&&(this.step="year"),c.isDate(this.start)&&c.isDate(this.end)&&c.isDate(this.value)||this._formatToDates(),this.end<this.start&&(this.end=this.start),this.value<this.start?this.value=this.start:this.value>this.end&&(this.value=this.end),this.playable===!1&&this.playing===!0&&(this.playing=!1)},play:function(){this.playing=!0},pause:function(){this.playing=!1},getRange:function(){return d3.time[this.unit].range(this.start,this.end,this.step)},getDimension:function(){return"time"},getFilter:function(){var a=d3.time.format(this.format||"%Y")(this.start),b=d3.time.format(this.format||"%Y")(this.end),c={time:[[a,b]]};return c},getFormatted:function(a,b){a||(a="%Y"),b||(b="value");var c=d3.time.format(a);return c(this[b])},snap:function(a){if(this.round){null==a&&(a="value");var b="round";"ceil"===this.round&&(b="ceil"),"floor"===this.round&&(b="floor");var c=d3.time[this.unit][b](this[a]);this.set(a,c,!0)}},_startPlaying:function(){if(this.playable&&!this._playing_now){this._playing_now=!0;var a=this,b=this.value,c=this.speed;this.snap(),a.end-b<=0&&(b=this.start,a.value=b),this._intervals.setInterval("playInterval_"+this._id,function(){return b>=a.end?void(a.loop?(b=a.start,a.value=b):a.playing=!1):(b=d3.time[a.unit].offset(b,a.step),void(a.value=b))},c),this.trigger("play")}},_stopPlaying:function(){this._playing_now=!1,this._intervals.clearInterval("playInterval_"+this._id),this.snap(),this.trigger("pause")}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.Reader.extend("inline",{init:function(a){this.name="inline",this._super(a)},read:function(){return(new b.Promise).resolve()}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.Promise;b.Reader.extend("local-json",{init:function(a){this._name="local-json",this._data=[],this._basepath=a.path,this._basepath||c.error("Missing base path for local-json reader")},read:function(a,b){var e=this,f=new d,g=this._basepath.replace("{{LANGUAGE}}",b);return e._data=[],function(a,b){d3.json(g,function(d,f){if(d)return void c.error("Error Happened While Loading File: "+g,d);var h=f[0],i=a.where;i["geo.category"]&&(i["geo.cat"]=c.clone(i["geo.category"]),delete i["geo.category"]);for(var j in i){var k=i[j];if("*"!==k[0])if("time"!==j)h=h.filter(function(a){var b=a[j],d=-1;return c.isArray(b)||(b=[b]),c.forEach(b,function(a,b){return-1!==k.indexOf(a)?(d=b,!1):void 0}),-1!==d});else{var l=k[0],m=l[0],n=l[1]||m;h=h.filter(function(a){var b=a[j];return b>=m&&n>=b})}}h=h.map(function(b){return c.clone(b,a.select)}),e._data=h,b.resolve()})}(a,f),f},getData:function(){return this._data}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.Promise;b.Reader.extend("waffle-server",{init:function(a){this._name="waffle-reader",this._data=[],this._basepath=a.path||"https://waffle.gapminder.org/api/v1/query"},read:function(a,b){var e,f=this,g=new d;this._data=[];var h=a.where;h.time&&(h.time=h.time[0].join("-")),h["geo.category"]&&(h["geo.cat"]=c.clone(h["geo.category"]),delete h["geo.category"]),e={SELECT:a.select,WHERE:h,FROM:"humnum"};var i={query:[e],lang:b};return c.post(this._basepath,i,function(a){f._data=a,g.resolve()},function(){console.log("Error loading from Waffle Server:",f._basepath),g.reject("Could not read from waffle server")},!0),g},getData:function(){return this._data}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils;if(b._require("d3")){var c="src/tools/barchart/barchart.html";b.Component.extend("gapminder-barchart",{init:function(a,b){this.name="barchart",this.template=c,this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}];var d=this;this.model_binds={"change:time:value":function(a){d.updateEntities()}},this._super(a,b),this.xScale=null,this.yScale=null,this.cScale=d3.scale.category10(),this.xAxis=d3.svg.axisSmart(),this.yAxis=d3.svg.axisSmart()},readyOnce:function(){this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.bars=this.graph.select(".vzb-bc-bars");var a=this;this.on("resize",function(){a.updateEntities()})},ready:function(){this.updateIndicators(),this.resize(),this.updateEntities()},updateIndicators:function(){var a=this;this.translator=this.model.language.getTFunction(),this.duration=this.model.time.speed,this.timeFormatter=d3.time.format(this.model.time.formatInput);var b=this.translator("indicator/"+this.model.marker.axis_y.which),c=this.yTitleEl.selectAll("text").data([0]);c.enter().append("text"),c.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(b),this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickFormat(a.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter)},updateEntities:function(){var a=this,b=this.model.time,c=b.value,d=b.playing?b.speed:0,e=this.model.marker.label.getItems({time:c});this.entityBars=this.bars.selectAll(".vzb-bc-bar").data(e),this.entityBars.exit().remove(),this.entityBars.enter().append("rect").attr("class","vzb-bc-bar").on("mousemove",function(a,b){}).on("mouseout",function(a,b){}).on("click",function(a,b){});var f=(this.bars.selectAll(".vzb-bc-bar"),this.xScale.rangeBand());this.bars.selectAll(".vzb-bc-bar").attr("width",f).attr("fill",function(b){return a.cScale(a.model.marker.color.getValue(b))}).attr("x",function(b){return a.xScale(a.model.marker.axis_x.getValue(b))}).transition().duration(d).ease("linear").attr("y",function(b){return a.yScale(a.model.marker.axis_y.getValue(b))}).attr("height",function(b){return a.height-a.yScale(a.model.marker.axis_y.getValue(b))})},resize:function(){var a=this;this.profiles={small:{margin:{top:30,right:20,left:40,bottom:40},padding:2,minRadius:2,maxRadius:40},medium:{margin:{top:30,right:60,left:60,bottom:40},padding:2,minRadius:3,maxRadius:60},large:{margin:{top:30,right:60,left:60,bottom:40},padding:2,minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var b=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],a.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width],a.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:b,limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:b}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xScale.rangeRoundBands([0,this.width],.1,.2),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis)},drawBars:function(){}}),b.Tool.extend("BarChart",{init:function(a,b){this.name="barchart",this.components=[{component:"gapminder-barchart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]}],this.default_options={state:{_type_:"model",_defs_:{time:{_type_:"model",_defs_:{start:1952,end:2012,value:2e3,step:1,speed:300,formatInput:"%Y"}},entities:{_type_:"model",_defs_:{show:{_type_:"model",_defs_:{dim:{_type_:"string",_defs_:"geo"},filter:{_type_:"object",_defs_:{geo:["*"],"geo.category":["region"]}}}}}},marker:{_type_:"model",_defs_:{dimensions:{_type_:"array",_defs_:["entities","time"]},label:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"property",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"geo.name"}}},axis_y:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"indicator"},which:{_type_:"string",_defs_:"lex"},scaleType:{_type_:"string",_defs_:"linear"}}},axis_x:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"property",_opts_:["property"]},which:{_type_:"string",_defs_:"geo.name"}}},color:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"property"},which:{_type_:"string",_defs_:"geo.region"},palette:{_type_:"object",_defs_:{_default:"#ffb600",world:"#ffb600",eur:"#FFE700",afr:"#00D5E9",asi:"#FF5872",ame:"#7FEB00"}}}}}}}},data:{_type_:"model",_defs_:{reader:{_type_:"string",_defs_:"local-json"},path:{_type_:"string",_defs_:"local_data/waffles/{{LANGUAGE}}/basic-indicators.json"}}},ui:{_type_:"model",_defs_:{buttons:{_type_:"array",_defs_:["fullscreen"]}}},language:{_type_:"model",_defs_:{id:{_type_:"string",_defs_:"en"},strings:{_type_:"object",_defs_:{en:{title:"","buttons/expand":"Full screen","buttons/unexpand":"Leave full screen","buttons/lock":"Lock","buttons/find":"Find","buttons/colors":"Colors","buttons/size":"Size","buttons/more_options":"Options","indicator/lex":"Life expectancy","indicator/gdp_per_cap":"GDP per capita","indicator/pop":"Population","indicator/geo.region":"Region","indicator/geo":"Geo code","indicator/time":"","indicator/geo.category":"Geo category"}}}}}},this._super(a,b)},validate:function(a){a=this.model||a;var b=a.state.time,c=a.state.marker.label;if(c.getItems()&&!(c.getItems().length<1)){var d=c.getLimits("time").min,e=c.getLimits("time").max;b.start<d&&(b.start=d),b.end>e&&(b.end=e)}}})}}.call(this),function(){Vizabi.Helper.extend("gapminder-bublechart-trails",{init:function(a){this.context=a},toggle:function(a){var b=this.context;a?(b._trails.create(),b._trails.run(["resize","recolor","findVisible","reveal"])):(b._trails.run("remove"),b.model.entities.select.forEach(function(a){a.trailStartTime=null}))},create:function(a){var b=this.context;if(b.model.time.trails&&b.model.entities.select.length){for(var c=+b.timeFormatter(b.model.time.start),d=+b.timeFormatter(b.model.time.end),e=b.model.time.step,f=[],g=c;d>=g;g+=e)f.push(g);a=null==a?b.model.entities.select:[a],a.forEach(function(a){var c=f.map(function(a){return{t:b.timeFormatter.parse(""+a)}});null==b.cached[a.geo]&&(b.cached[a.geo]={}),b.cached[a.geo].maxMinValues={valueXmax:null,valueXmin:null,valueYmax:null,valueYmin:null,valueSmax:null};var d=b.cached[a.geo].maxMinValues,e=b.entityTrails.filter(function(b){return b.geo==a.geo}).selectAll("g").data(c);e.exit().remove(),e.enter().append("g").attr("class","trailSegment").on("mousemove",function(a,c){var d=d3.select(this.parentNode).data()[0].geo;b._axisProjections({geo:d,time:a.t}),b._setTooltip(b.timeFormatter(a.t)),b.entityLabels.filter(function(a){return a.geo==d}).classed("vzb-highlighted",!0)}).on("mouseout",function(a,c){b._axisProjections(),b._setTooltip(),b.entityLabels.classed("vzb-highlighted",!1)}).each(function(a,b){var c=d3.select(this);c.append("circle"),c.append("line")}),e.each(function(c,e){c.valueY=b.model.marker.axis_y.getValue({geo:a.geo,time:c.t}),c.valueX=b.model.marker.axis_x.getValue({geo:a.geo,time:c.t}),c.valueS=b.model.marker.size.getValue({geo:a.geo,time:c.t}),c.valueC=b.model.marker.color.getValue({geo:a.geo,time:c.t}),(c.valueX>d.valueXmax||null==d.valueXmax)&&(d.valueXmax=c.valueX),(c.valueX<d.valueXmin||null==d.valueXmin)&&(d.valueXmin=c.valueX),(c.valueY>d.valueYmax||null==d.valueYmax)&&(d.valueYmax=c.valueY),(c.valueY<d.valueYmin||null==d.valueYmin)&&(d.valueYmin=c.valueY),(c.valueS>d.valueSmax||null==d.valueSmax)&&(d.valueSmax=c.valueS)})})}},run:function(a,b,c){var d=this.context;(d.model.time.trails&&d.model.entities.select.length||"remove"==a)&&(c||(c=0),a=[].concat(a),b=null==b?d.model.entities.select:[b],b.forEach(function(b){var e=d.entityTrails.filter(function(a){return a.geo==b.geo}).selectAll("g");a.forEach(function(a){d._trails["_"+a](e,c,b)})}))},_remove:function(a,b,c){a.remove()},_resize:function(a,b,c){var d=this.context;a.each(function(a,b){var c=d3.select(this);c.select("circle").attr("cy",d.yScale(a.valueY)).attr("cx",d.xScale(a.valueX)).attr("r",_areaToRadius(d.sScale(a.valueS)));var e=this.parentNode.children[b+1];null!=e&&(e=e.__data__,c.select("line").attr("x1",d.xScale(e.valueX)).attr("y1",d.yScale(e.valueY)).attr("x2",d.xScale(a.valueX)).attr("y2",d.yScale(a.valueY)))})},_recolor:function(a,b,c){var d=this.context;a.each(function(a,b){var c=d3.select(this);c.select("circle").style("fill",d.cScale(a.valueC)),c.select("line").style("stroke",d.cScale(a.valueC))})},_findVisible:function(a,b,c){var d=this.context,e=!0,f=d.timeFormatter.parse(""+c.trailStartTime);a.each(function(a,b){a.transparent=a.t-d.time>=0||f-a.t>0||c.trailStartTime-d.timeFormatter(d.time)>=0,e&&!a.transparent&&(d.cached[c.geo].labelX0=a.valueX,d.cached[c.geo].labelY0=a.valueY,d.cached[c.geo].scaledS0=_areaToRadius(d.sScale(a.valueS)),e=!1)})},_reveal:function(a,b,c){var d=this.context;a.each(function(a,b){var e=d3.select(this);if(e.classed("vzb-invisible",a.transparent),!a.transparent){var f=this.parentNode.children[b+1];null!=f&&(f=f.__data__,a.t-d.time<=0&&d.time-f.t<=0?(f=d.cached[c.geo],e.select("line").attr("x2",d.xScale(a.valueX)).attr("y2",d.yScale(a.valueY)).attr("x1",d.xScale(a.valueX)).attr("y1",d.yScale(a.valueY)).attr("x1",d.xScale(f.valueX)).attr("y1",d.yScale(f.valueY))):e.select("line").attr("x2",d.xScale(a.valueX)).attr("y2",d.yScale(a.valueY)).attr("x1",d.xScale(f.valueX)).attr("y1",d.yScale(f.valueY)))}})}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&(b.Component.extend("gapminder-bubblechart",{init:function(a,d){var e=this;this.name="bubblechart",this.template="src/tools/bubblechart/bubblechart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}],this.model_binds={"change:time:trails":function(a){e._trails.toggle(e.model.time.trails),e.redrawDataPoints()},"change:time:lockNonSelected":function(a){e.redrawDataPoints(500)},"change:entities:show":function(a){e.entitiesUpdatedRecently=!0},"change:marker":function(a){},"change:entities:select":function(){},"change:entities:brush":function(){},readyOnce:function(a){},ready:function(a){},"change:time:value":function(){e.updateTime(),e._trails.run("findVisible"),e.model.time.adaptMinMaxZoom?e.adaptMinMaxZoom():e.redrawDataPoints(),e._trails.run("reveal")},"change:time:adaptMinMaxZoom":function(){e.model.time.adaptMinMaxZoom?e.adaptMinMaxZoom():e.resetZoomer()},"change:marker:size:max":function(){e.updateMarkerSizeLimits(),e._trails.run("findVisible"),e.redrawDataPointsOnlySize(),e._trails.run("resize")},"change:marker:color:palette":function(){e.redrawDataPointsOnlyColors(),e._trails.run("recolor")},"change:entities:opacitySelectDim":function(){e.updateBubbleOpacity()},"change:entities:opacityRegular":function(){e.updateBubbleOpacity()}},this._super(a,d),this.xScale=null,this.yScale=null,this.sScale=null,this.cScale=null,this.xAxis=d3.svg.axisSmart(),this.yAxis=d3.svg.axisSmart(),this.cached={},this.xyMaxMinMean={},this.currentZoomFrameXY=null,this.ui=c.extend({whenHovering:{},labels:{}},this.ui["vzb-tool-"+this.name]),this.ui.whenHovering=c.extend({showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},this.ui.whenHovering),this.ui.labels=c.extend({autoResolveCollisions:!1,dragging:!0},this.ui.labels);var f=b.Helper.get("gapminder-bublechart-trails");this._trails=new f(this),this.dragger=d3.behavior.drag().on("dragstart",function(a,b){d3.event.sourceEvent.stopPropagation()}).on("drag",function(a,b){if(e.ui.labels.dragging){var c=e.cached[a.geo];c.labelFixed=!0,c.labelX_+=d3.event.dx/e.width,c.labelY_+=d3.event.dy/e.height;var d=e.xScale(c.labelX0)+c.labelX_*e.width,f=e.yScale(c.labelY0)+c.labelY_*e.height,g=e.xScale(c.labelX0),h=e.yScale(c.labelY0);e._repositionLabels(a,b,this,d,f,g,h,0)}}).on("dragend",function(a,b){e.model.entities.setLabelOffset(a,[Math.round(100*e.cached[a.geo].labelX_)/100,Math.round(100*e.cached[a.geo].labelY_)/100])}),this.gragRectangle=d3.behavior.drag().on("dragstart",function(a,b){(d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey)&&(this.ctrlKeyLock=!0,this.origin={x:d3.mouse(this)[0]-e.activeProfile.margin.left,y:d3.mouse(this)[1]-e.activeProfile.margin.top},e.zoomRect.classed("vzb-invisible",!1))}).on("drag",function(a,b){if(this.ctrlKeyLock){var c=this.origin,d={x:d3.event.x-e.activeProfile.margin.left,y:d3.event.y-e.activeProfile.margin.top};e.zoomRect.attr("x",Math.min(d.x,c.x)).attr("y",Math.min(d.y,c.y)).attr("width",Math.abs(d.x-c.x)).attr("height",Math.abs(d.y-c.y))}}).on("dragend",function(a){this.ctrlKeyLock&&(this.ctrlKeyLock=!1,e.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0),this.target={x:d3.mouse(this)[0]-e.activeProfile.margin.left,y:d3.mouse(this)[1]-e.activeProfile.margin.top},e._zoomOnRectangle(d3.select(this),this.origin.x,this.origin.y,this.target.x,this.target.y,!0,500))}),this.zoomer=d3.behavior.zoom().scaleExtent([1,100]).on("zoom",function(){if(null==d3.event.sourceEvent||!d3.event.sourceEvent.ctrlKey&&!d3.event.sourceEvent.metaKey){var a=d3.event.scale,b=d3.event.translate,c=e.zoomer.ratioY,d=e.zoomer.ratioX;(isNaN(a)||null==a)&&(a=e.zoomer.scale()),(isNaN(a)||null==a)&&(a=1),(isNaN(b[0])||isNaN(b[1])||null==b[0]||null==b[1])&&(b=e.zoomer.translate()),(isNaN(b[0])||isNaN(b[1])||null==b[0]||null==b[1])&&(b=[0,0]),1>a*c&&(c=1/a,e.zoomer.ratioY=c),1>a*d&&(d=1/a,e.zoomer.ratioX=d),b[0]>0&&(b[0]=0),b[1]>0&&(b[1]=0),b[0]<(1-a*d)*e.width&&(b[0]=(1-a*d)*e.width),b[1]<(1-a*c)*e.height&&(b[1]=(1-a*c)*e.height),e.zoomer.translate(b),e.xScale.range([0*a*d+b[0],e.width*a*d+b[0]]),e.yScale.range([e.height*a*c+b[1],0*a*c+b[1]]);var f=e.yAxis.labelerOptions(),g=e.xAxis.labelerOptions();f.limitMaxTickNumber=2>a*c?7:14,f.transitionDuration=e.zoomer.duration,g.transitionDuration=e.zoomer.duration,e.xAxisEl.call(e.xAxis.labelerOptions(g)),e.yAxisEl.call(e.yAxis.labelerOptions(f)),e.redrawDataPoints(e.zoomer.duration),e._trails.run("resize",null,e.zoomer.duration),e.zoomer.duration=0}}),this.zoomer.ratioX=1,this.zoomer.ratioY=1},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisElContainer=this.graph.select(".vzb-bc-axis-y"),this.yAxisEl=this.yAxisElContainer.select("g"),this.xAxisElContainer=this.graph.select(".vzb-bc-axis-x"),this.xAxisEl=this.xAxisElContainer.select("g"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.sTitleEl=this.graph.select(".vzb-bc-axis-s-title"),this.cTitleEl=this.graph.select(".vzb-bc-axis-c-title"),this.yearEl=this.graph.select(".vzb-bc-year"),this.projectionX=this.graph.select(".vzb-bc-projection-x"),this.projectionY=this.graph.select(".vzb-bc-projection-y"),this.trailsContainer=this.graph.select(".vzb-bc-trails"),this.bubbleContainerCrop=this.graph.select(".vzb-bc-bubbles-crop"),this.bubbleContainer=this.graph.select(".vzb-bc-bubbles"),this.labelsContainer=this.graph.select(".vzb-bc-labels"),this.zoomRect=this.element.select(".vzb-bc-zoomRect"),this.entityBubbles=null,this.entityLabels=null,this.tooltip=this.element.select(".vzb-tooltip"),this.on("resize",function(){a.updateSize(),a.updateMarkerSizeLimits(),a._trails.run("findVisible"),a.resetZoomer()}),d3.select("body").on("keydown",function(){(d3.event.metaKey||d3.event.ctrlKey)&&a.element.select("svg").classed("vzb-zoomin",!0)}).on("keyup",function(){d3.event.metaKey||d3.event.ctrlKey||a.element.select("svg").classed("vzb-zoomin",!1)}),this.element.call(this.zoomer).call(this.gragRectangle)},updateIndicators:function(){var a=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickFormat(a.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter),this.xyMaxMinMean={x:this.model.marker.axis_x.getMaxMinMean(this.timeFormatter),y:this.model.marker.axis_y.getMaxMinMean(this.timeFormatter),s:this.model.marker.size.getMaxMinMean(this.timeFormatter)}},updateUIStrings:function(){var a=this;this.translator=this.model.language.getTFunction(),this.timeFormatter=d3.time.format(a.model.time.formatInput);var b=this.translator("indicator/"+this.model.marker.axis_y.value),c=this.translator("indicator/"+this.model.marker.axis_x.value),d=this.translator("indicator/"+this.model.marker.size.value),e=this.translator("indicator/"+this.model.marker.color.value);this.model.marker.axis_y.unit&&(b=b+", "+this.model.marker.axis_y.unit),this.model.marker.axis_x.unit&&(c=c+", "+this.model.marker.axis_x.unit),this.model.marker.size.unit&&(d=d+", "+this.model.marker.size.unit),this.model.marker.color.unit&&(e=e+", "+this.model.marker.color.unit);var f=this.yTitleEl.selectAll("text").data([0]);f.enter().append("text"),f.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(b);var g=this.xTitleEl.selectAll("text").data([0]);g.enter().append("text"),g.attr("text-anchor","end").attr("y","-0.32em").text(c);var h=this.sTitleEl.selectAll("text").data([0]);h.enter().append("text"),h.attr("text-anchor","end").text(this.translator("buttons/size")+": "+d+", "+this.translator("buttons/colors")+": "+e)},updateEntities:function(){var a=this,b=a.model.time.end;this.model.entities.visible=this.model.marker.label.getItems().map(function(c){return{geo:c.geo,time:b,sortValue:a.model.marker.size.getValue({geo:c.geo,time:b})}}).sort(function(a,b){return b.sortValue-a.sortValue}),this.entityBubbles=this.bubbleContainer.selectAll(".vzb-bc-entity").data(this.model.entities.visible,function(a){return a.geo}),this.entityBubbles.exit().remove(),this.entityBubbles.enter().append("circle").attr("class","vzb-bc-entity").on("mousemove",function(b,c){a.model.entities.highlightEntity(b),a.model.entities.isSelected(b)&&a.model.time.trails?(text=a.timeFormatter(a.time),a.entityLabels.filter(function(a){return a.geo==b.geo}).classed("vzb-highlighted",!0)):text=a.model.marker.label.getValue(b),a._setTooltip(text)}).on("mouseout",function(b,c){a.model.entities.clearHighlighted(),a._setTooltip(),a.entityLabels.classed("vzb-highlighted",!1)}).on("click",function(b,c){a.model.entities.selectEntity(b,a.timeFormatter)}),this.entityTrails=this.trailsContainer.selectAll(".vzb-bc-entity").data(this.model.entities.visible,function(a){return a.geo}),this.entityTrails.exit().remove(),this.entityTrails.enter().append("g").attr("class",function(a){return"vzb-bc-entity "+a.geo})},adaptMinMaxZoom:function(){var a=this,b=a.xyMaxMinMean.x[a.timeFormatter(a.time)],d=a.xyMaxMinMean.y[a.timeFormatter(a.time)],e=_areaToRadius(a.sScale(a.xyMaxMinMean.s[a.timeFormatter(a.time)].max)),f=a.currentZoomFrameXY,g={x1:a.xScale(b.min)-e,y1:a.yScale(d.min)+e,x2:a.xScale(b.max)+e,y2:a.yScale(d.max)-e},h=.3;if(!f||g.x1<f.x1*(1-h)||g.x2>f.x2*(1+h)||g.y2<f.y2*(1-h)||g.y1>f.y1*(1+h)){a.currentZoomFrameXY=c.clone(g);var f=a.currentZoomFrameXY;a._zoomOnRectangle(a.element,f.x1,f.y1,f.x2,f.y2,!1,a.duration)}else a.redrawDataPoints(a.duration)},_zoomOnRectangle:function(a,b,c,d,e,f,g){var h=this,i=h.zoomer;if(!(Math.abs(b-d)<10||Math.abs(c-e)<10)){if(Math.abs(b-d)>Math.abs(c-e))var j=h.height/Math.abs(c-e)*i.scale(),k=h.width/Math.abs(b-d)*i.scale()/j*i.ratioX,l=i.ratioY;else var j=h.width/Math.abs(b-d)*i.scale(),l=h.height/Math.abs(c-e)*i.scale()/j*i.ratioY,k=i.ratioX;f&&i.translate([i.translate()[0]+b-d,i.translate()[1]+c-e]);var m=[(i.translate()[0]-Math.min(b,d))/i.scale()/i.ratioX*j*k,(i.translate()[1]-Math.min(c,e))/i.scale()/i.ratioY*j*l];i.scale(j),i.ratioY=l,i.ratioX=k,i.translate(m),i.duration=g?g:0,i.event(a)}},resetZoomer:function(a){this.zoomer.scale(1),this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.translate([0,0]),this.zoomer.duration=0,this.zoomer.event(a||this.element)},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.speed:0,this.yearEl.text(this.timeFormatter(this.time))},updateSize:function(){var a=this;this.profiles={small:{margin:{top:30,right:20,left:40,bottom:40},padding:2,minRadius:2,maxRadius:40},medium:{margin:{top:30,right:60,left:60,bottom:40},padding:2,minRadius:3,maxRadius:60},large:{margin:{top:30,right:60,left:60,bottom:40},padding:2,minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var b=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),this.yearEl.attr("x",this.width/2).attr("y",this.height/3*2).style("font-size",Math.max(this.height/4,this.width/4)+"px"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],a.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width],a.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:b,limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:b}),this.bubbleContainerCrop.attr("width",this.width).attr("height",this.height),this.xAxisElContainer.attr("width",this.width).attr("height",this.activeProfile.margin.bottom).attr("y",this.height),this.xAxisEl.attr("transform","translate(0,1)"),this.yAxisElContainer.attr("width",this.activeProfile.margin.left).attr("height",this.height).attr("x",-this.activeProfile.margin.left),this.yAxisEl.attr("transform","translate("+(this.activeProfile.margin.left-1)+",0)"),this.xTitleEl.attr("transform","translate("+this.width+","+this.height+")"),this.sTitleEl.attr("transform","translate("+this.width+",0) rotate(-90)"),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.projectionX.attr("y1",a.yScale.range()[0]),this.projectionY.attr("x2",a.xScale.range()[0])},updateMarkerSizeLimits:function(){var a=this,b=this.activeProfile.minRadius,c=this.activeProfile.maxRadius;this.minRadius=Math.max(c*this.model.marker.size.min,b),this.maxRadius=c*this.model.marker.size.max,"ordinal"!==this.model.marker.size.scaleType?this.sScale.range([_radiusToArea(a.minRadius),_radiusToArea(a.maxRadius)]):this.sScale.rangePoints([_radiusToArea(a.minRadius),_radiusToArea(a.maxRadius)],0).range()},redrawDataPointsOnlyColors:function(){var a=this;this.entityBubbles.style("fill",function(b){var c=a.model.marker.color.getValue({geo:b.geo,time:a.time});return a.cScale(c)})},redrawDataPointsOnlySize:function(){var a=this;this.someSelected?a.entityBubbles.each(function(b,c){a._updateBubble(b,c,d3.select(this),0)}):this.entityBubbles.each(function(b,c){var d=a.model.marker.size.getValue(b);null!=d&&d3.select(this).attr("r",_areaToRadius(a.sScale(d)))})},redrawDataPoints:function(a){var b=this;null==a&&(a=b.duration),this.entityBubbles.each(function(c,d){var e=d3.select(this);b._updateBubble(c,d,e,a)}),0==b.duration&&d3.timer.flush(),b.ui.labels.autoResolveCollisions&&(clearTimeout(b.collisionTimeout),b.collisionTimeout=setTimeout(function(){},1.2*b.model.time.speed))},_updateBubble:function(a,b,c,d){var e=this;e.model.time.lockNonSelected&&e.someSelected&&!e.model.entities.isSelected(a)?a.time=e.timeFormatter.parse(""+e.model.time.lockNonSelected):a.time=e.time;var f=e.model.marker.axis_y.getValue(a),g=e.model.marker.axis_x.getValue(a),h=e.model.marker.size.getValue(a),i=e.model.marker.label.getValue(a),j=e.model.marker.color.getValue(a);if(null==i||null==f||null==g||null==h)c.classed("vzb-invisible",!0);else{var k=_areaToRadius(e.sScale(h));c.classed("vzb-invisible",!1).style("fill",e.cScale(j)).transition().duration(d).ease("linear").attr("cy",e.yScale(f)).attr("cx",e.xScale(g)).attr("r",k),
e._updateLabel(a,b,g,f,k,i,d)}},_updateLabel:function(a,b,d,e,f,g,h){var i=this;if(null==h&&(h=i.duration),i.model.entities.isSelected(a)&&null!=i.entityLabels){null==i.cached[a.geo]&&(i.cached[a.geo]={});var j=i.cached[a.geo],k=c.find(i.model.entities.select,function(b){return b.geo==a.geo}),l=i.timeFormatter.parse(""+k.trailStartTime);j.valueX=d,j.valueY=e,(!i.model.time.trails||l-i.time>0||null==k.trailStartTime)&&(k.trailStartTime=i.timeFormatter(i.time),j.scaledS0=f,j.labelX0=d,j.labelY0=e),(null==j.scaledS0||null==j.labelX0||null==j.labelX0)&&(j.scaledS0=f,j.labelX0=d,j.labelY0=e),i.entityLabels.filter(function(b){return b.geo==a.geo}).each(function(c){var d=d3.select(this),e=d.selectAll("text.vzb-bc-label-content").text(g+(i.model.time.trails?" "+k.trailStartTime:"")),f=(d.select("line").style("stroke-dasharray","0 "+(j.scaledS0+2)+" 100%"),d.select("rect")),l=e[0][0].getBBox();j.contentBBox&&j.contentBBox.width==l.width||(j.contentBBox=l,d.select("text.vzb-bc-label-x").attr("x",l.width+0*l.height+2).attr("y",0*l.height-4),d.select("circle").attr("cx",l.width+0*l.height+2).attr("cy",0*l.height-4).attr("r",.5*l.height),f.attr("width",l.width+4).attr("height",l.height+4).attr("x",-2).attr("y",-4).attr("rx",.2*l.height).attr("ry",.2*l.height)),j.labelX_=k.labelOffset[0]||j.scaledS0/i.width,j.labelY_=k.labelOffset[1]||j.scaledS0/i.width;var m=i.xScale(j.labelX0)+j.labelX_*i.width,n=i.yScale(j.labelY0)+j.labelY_*i.height,o=m>0?m<i.width-j.contentBBox.width?m:i.width-j.contentBBox.width:0,p=n>0?n<i.height-j.contentBBox.height?n:i.height-j.contentBBox.height:0,q=i.xScale(j.labelX0),r=i.yScale(j.labelY0);j.stuckOnLimit=o!=m||p!=n,f.classed("vzb-transparent",!j.stuckOnLimit),i._repositionLabels(a,b,this,o,p,q,r,h)})}else null!=i.cached[a.geo]&&delete i.cached[a.geo]},_repositionLabels:function(a,b,c,d,e,f,g,h){var i=d3.select(c);i.transition().duration(h||0).ease("linear").attr("transform","translate("+d+","+e+")"),i.selectAll("line").attr("x1",f-d).attr("y1",g-e)},selectDataPoints:function(){var a=this;a.someSelected=a.model.entities.select.length>0,this.entityLabels=this.labelsContainer.selectAll(".vzb-bc-entity").data(a.model.entities.select,function(a){return a.geo}),this.entityLabels.exit().each(function(b){a._trails.run("remove",b)}).remove(),this.entityLabels.enter().append("g").attr("class","vzb-bc-entity").call(a.dragger).each(function(b,c){var d=d3.select(this);d.append("line").attr("class","vzb-bc-label-line"),d.append("rect").attr("class","vzb-transparent").on("click",function(b,c){if(!d3.event.defaultPrevented){var d=a.cached[b.geo].maxMinValues,e=_areaToRadius(a.sScale(d.valueSmax));a._zoomOnRectangle(a.element,a.xScale(d.valueXmin)-e,a.yScale(d.valueYmin)+e,a.xScale(d.valueXmax)+e,a.yScale(d.valueYmax)-e,!1,500)}}),d.append("text").attr("class","vzb-bc-label-content vzb-bc-label-shadow"),d.append("text").attr("class","vzb-bc-label-content"),d.append("circle").attr("class","vzb-bc-label-x vzb-bc-label-shadow vzb-transparent").on("click",function(b,c){d3.event.defaultPrevented||a.model.entities.selectEntity(b)}),d.append("text").attr("class","vzb-bc-label-x vzb-transparent").text("x"),a._trails.create(b)}).on("mousemove",function(){d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!1),d3.select(this).select("rect").classed("vzb-transparent",!1)}).on("mouseout",function(b){d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!0),d3.select(this).select("rect").classed("vzb-transparent",!a.cached[b.geo].stuckOnLimit)})},_setTooltip:function(a){if(a){var b=d3.mouse(this.graph.node()).map(function(a){return parseInt(a)});this.tooltip.classed("vzb-hidden",!1).attr("style","left:"+(b[0]+50)+"px;top:"+(b[1]+50)+"px").html(a)}else this.tooltip.classed("vzb-hidden",!0)},_axisProjections:function(a){if(null!=a){var b=this.model.marker.axis_y.getValue(a),c=this.model.marker.axis_x.getValue(a),d=this.model.marker.size.getValue(a),e=_areaToRadius(this.sScale(d));this.ui.whenHovering.showProjectionLineX&&this.projectionX.style("opacity",1).attr("y2",this.yScale(b)+e).attr("x1",this.xScale(c)).attr("x2",this.xScale(c)),this.ui.whenHovering.showProjectionLineY&&this.projectionY.style("opacity",1).attr("y1",this.yScale(b)).attr("y2",this.yScale(b)).attr("x1",this.xScale(c)-e),this.ui.whenHovering.higlightValueX&&this.xAxisEl.call(this.xAxis.highlightValue(c)),this.ui.whenHovering.higlightValueY&&this.yAxisEl.call(this.yAxis.highlightValue(b))}else this.projectionX.style("opacity",0),this.projectionY.style("opacity",0),this.xAxisEl.call(this.xAxis.highlightValue("none")),this.yAxisEl.call(this.yAxis.highlightValue("none"))},highlightDataPoints:function(){var a=this;if(this.someHighlighted=this.model.entities.brush.length>0,this.updateBubbleOpacity(),1===this.model.entities.brush.length){var b=c.clone(this.model.entities.brush[0]);a.model.time.lockNonSelected&&a.someSelected&&!a.model.entities.isSelected(b)?b.time=a.timeFormatter.parse(""+a.model.time.lockNonSelected):b.time=a.time,this._axisProjections(b)}else this._axisProjections()},updateBubbleOpacity:function(a){var b=this,c=1,d=.3,e=.8,f=this.model.entities.opacityRegular,g=this.model.entities.opacitySelectDim;this.entityBubbles.style("opacity",function(a){return b.someHighlighted&&b.model.entities.isHighlighted(a)?c:b.someSelected?b.model.entities.isSelected(a)?e:g:b.someHighlighted?d:f});var h=b.someSelected&&b.model.entities.opacitySelectDim<.01;h!=this.someSelectedAndOpacityZero_1&&this.entityBubbles.style("pointer-events",function(a){return!h||b.model.entities.isSelected(a)?"visible":"none"}),this.someSelectedAndOpacityZero_1=b.someSelected&&b.model.entities.opacitySelectDim<.01}}),b.Tool.extend("BubbleChart",{init:function(a,b){this.name="bubblechart",this.components=[{component:"gapminder-bubblechart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]}],this.default_options={state:{_type_:"model",_defs_:{time:{_type_:"model",_defs_:{start:1952,end:2012,value:2e3,step:1,speed:300,round:"ceil",formatInput:"%Y",trails:!0,lockNonSelected:0,adaptMinMaxZoom:!1}},entities:{_type_:"model",_defs_:{show:{_type_:"model",_defs_:{dim:{_type_:"string",_defs_:"geo"},filter:{_type_:"object",_defs_:{geo:["afg","alb","dza","ago","atg","arg","arm","abw","aus","aut","aze","bhs","bhr","bgd","brb","blr","bel","blz","ben","btn","bol","bih","bwa","bra","chn","brn","bgr","bfa","bdi","khm","cmr","can","cpv","caf","tcd","_cis","chl","col","com","cod","cog","cri","civ","hrv","cub","cyp","cze","dnk","dji","dom","ecu","egy","slv","gnq","eri","est","eth","fji","fin","fra","guf","pyf","gab","gmb","geo","deu","gha","grc","grd","glp","gum","gtm","gin","gnb","guy","hti","hnd","hkg","hun","isl","ind","idn","irn","irq","irl","isr","ita","jam","jpn","jor","kaz","ken","kir","prk","kor","kwt","kgz","lao","lva","lbn","lso","lbr","lby","ltu","lux","mac","mkd","mdg","mwi","mys","mdv","mli","mlt","mtq","mrt","mus","myt","mex","fsm","mda","mng","mne","mar","moz","mmr","nam","npl","nld","ant","ncl","nzl","nic","ner","nga","nor","omn","pak","pan","png","pry","per","phl","pol","prt","pri","qat","reu","rou","rus","rwa","lca","vct","wsm","stp","sau","sen","srb","syc","sle","sgp","svk","svn","slb","som","zaf","sds","esp","lka","sdn","sur","swz","swe","che","syr","twn","tjk","tza","tha","tls","tgo","ton","tto","tun","tur","tkm","uga","ukr","are","gbr","usa","ury","uzb","vut","ven","pse","esh","vnm","vir","yem","zmb","zwe"],"geo.cat":["country"]}}}}}},marker:{_type_:"model",_defs_:{dimensions:{_type_:"array",_defs_:["entities","time"]},type:"geometry",shape:"circle",label:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"property",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"geo.name"}}},axis_y:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"indicator",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"lex"},scaleType:{_type_:"string",_defs_:"linear"},unit:{_type_:"string",_defs_:"years"}}},axis_x:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"indicator",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"gdp_per_cap"},scaleType:{_type_:"string",_defs_:"log"},unit:{_type_:"string",_defs_:"$/year/person"}}},size:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"indicator",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"pop"},scaleType:{_type_:"string",_defs_:"linear"},max:{_type_:"number",_defs_:.75},unit:{_type_:"string",_defs_:""}}},color:{_type_:"hook",_defs_:{use:{_type_:"string",_defs_:"property",_opts_:["property","indicator","value"]},which:{_type_:"string",_defs_:"geo.region"},scaleType:{_type_:"string",_defs_:"ordinal"},unit:{_type_:"string",_defs_:""}}}}}}},data:{_type_:"model",_defs_:{reader:{_type_:"string",_defs_:"local-json"},path:{_type_:"string",_defs_:"local_data/waffles/{{LANGUAGE}}/basic-indicators.json"}}},ui:{_type_:"model",_defs_:{"vzb-tool-bar-chart":{_type_:"object",_defs_:{whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{autoResolveCollisions:!0,dragging:!0}}},buttons:{_type_:"array",_defs_:["fullscreen"]}}},language:{_type_:"model",_defs_:{id:{_type_:"string",_defs_:"en"},strings:{_type_:"object",_defs_:{en:{title:"Bubble Chart Title","buttons/expand":"Go big","buttons/unexpand":"Go small","buttons/trails":"Trails","buttons/lock":"Lock","buttons/find":"Find","buttons/deselect":"Deselect","buttons/ok":"OK","buttons/colors":"Colors","buttons/size":"Size","buttons/axes":"Axes","buttons/more_options":"Options","indicator/lex":"Life expectancy","indicator/gdp_per_cap":"GDP per capita","indicator/pop":"Population","indicator/geo.region":"Region","indicator/geo":"Geo code","indicator/time":"Time","indicator/geo.category":"Geo category","scaletype/linear":"Linear","scaletype/log":"Logarithmic","scaletype/genericLog":"Generic log","scaletype/time":"Time","scaletype/ordinal":"Ordinal","color/geo.region/asi":"Asia","color/geo.region/eur":"Europe","color/geo.region/ame":"Americas","color/geo.region/afr":"Afrika","color/geo.region/_default":"Other"},pt:{title:"Título do Bubble Chart","buttons/expand":"Expandir","buttons/unexpand":"Nia expandir","buttons/trails":"Led","buttons/lock":"Lås","buttons/find":"Encontre","buttons/deselect":"Välj ingen","buttons/ok":"Okej","buttons/colors":"Cores","buttons/size":"Tamanho","buttons/axes":"Axlar","buttons/more_options":"Opções","indicator/lex":"Expectables Livappulo","indicator/gdp_per_cap":"PIB pers capitous","indicator/pop":"Peoples","indicator/geo.region":"Regiono","indicator/geo":"Geo codo","indicator/time":"Tid","indicator/geo.category":"Geo catego","scaletype/linear":"Linjär","scaletype/log":"Logaritmisk","scaletype/genericLog":"Allmän log","scaletype/time":"Tid","scaletype/ordinal":"Ordning","geo.region/asi":"Asien","geo.region/eur":"Europa","geo.region/ame":"Amerikor","geo.region/afr":"Afrika","geo.region/_default":"Other"}}}}}},this._super(a,b)},validate:function(a){a=this.model||a;var b=a.state.time,c=a.state.marker.label;if(c.getItems()&&!(c.getItems().length<1)){var d=c.getLimits("time").min,e=c.getLimits("time").max;b.start<d&&(b.start=d),b.end>e&&(b.end=e)}}}))}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.axisSmart=function(){return function a(b){function c(a,b,c){return c.indexOf(a)===b}function d(a){if(null!=o)return void d.highlightValueRun(a);var c=a.append("g").attr("class","tick widthSampling"),e=c.append("text").text("0");u.cssMarginTop=e.style("margin-top"),u.cssMarginBottom=e.style("margin-bottom"),u.cssMarginLeft=e.style("margin-left"),u.cssMarginRight=e.style("margin-right"),u.widthOfOneDigit=e[0][0].getBBox().width,u.heightOfOneDigit=e[0][0].getBBox().height,c.remove(),d.labelFactory(u),b(u.transitionDuration>0?a.transition().duration(u.transitionDuration):a);var f="top"==d.orient()||"bottom"==d.orient()?i:h,g=f==i&&d.pivot()||f==h&&!d.pivot()?k:j;a.selectAll(".vzb-axis-value").data([null]).enter().append("g").attr("class","vzb-axis-value").append("text").style("opacity",0),a.selectAll("text").each(function(a,b){var c=d3.select(this);if(null!=d.pivot()&&(c.attr("transform","rotate("+(d.pivot()?-90:0)+")"),c.style("text-anchor",g==j?"middle":"end"),c.attr("x",g==j?0:-d.tickPadding()-d.tickSize()),c.attr("y",g==j?(f==h?-1:1)*(d.tickPadding()+d.tickSize()):0),c.attr("dy",g==j?f==h?0:".72em":".32em"),null!=d.repositionLabels())){var e=d.repositionLabels()[b]||{x:0,y:0};c.attr("x",+c.attr("x")+e.x),c.attr("y",+c.attr("y")+e.y)}}),null==d.tickValuesMinor()&&d.tickValuesMinor([]);var l=a.selectAll(".tickMinor").data(s);l.exit().remove(),l.enter().append("line").attr("class","tickMinor");var m=d.tickSizeMinor().outbound,n=d.tickSizeMinor().inbound,p=d.scale();l.attr("y1",f==i?("top"==d.orient()?1:-1)*n:p).attr("y2",f==i?("top"==d.orient()?-1:1)*m:p).attr("x1",f==h?("right"==d.orient()?-1:1)*n:p).attr("x2",f==h?("right"==d.orient()?1:-1)*m:p)}function e(a,b){null==b&&(b=!0);var c=[],d=[];-1!=a.indexOf(0)&&(c.push([0]),d.push(a.indexOf(0)));for(var e=a.length;e>=1;e=4>e?e-1:e/2)c.push(a.filter(function(a,c){return c%Math.floor(e)!=0||-1!=d.indexOf(c)&&b?!1:(d.push(c),!0)}));return c}function f(a,b,c,d,e){if(null==a)return null;var f=c==h?{head:b.toolMargin.top,tail:b.toolMargin.bottom}:{head:b.toolMargin.right,tail:b.toolMargin.left},g={};return a.forEach(function(j,k){if(0==k||k==a.length-1){var l=f.head+(c==i?1:0)*d3.max(d.range())-(c==i?0:1)*d3.min(d.range())+(c==i?-1:1)*d(j)-("x"==e)*b.formatter(j).length*b.widthOfOneDigit/2-("y"==e)*b.heightOfOneDigit/2,m=Math.min(f.tail,b.widthOfOneDigit)+(c==h?1:0)*d3.max(d.range())-(c==h?0:1)*d3.min(d.range())+(c==h?-1:1)*d(j)-("x"==e)*b.formatter(j).length*b.widthOfOneDigit/2-("y"==e)*b.heightOfOneDigit/2;l>0&&(l=0),m>0&&(m=0),g[k]={x:0,y:0},g[k][e]=("y"==e&&c==h?-1:1)*(l-m)}}),a.forEach(function(f,j){if(0!=j&&j!=a.length-1){var k=Math.abs(d(f)-d(a[a.length-1]))-("y"==e&&c==i?-1:1)*g[a.length-1][e]-("x"==e)*b.widthOfOneDigit/2*b.formatter(f).length-("x"==e)*b.widthOfOneDigit/2*b.formatter(a[a.length-1]).length-("y"==e)*b.heightOfOneDigit*.7,l=Math.abs(d(f)-d(a[0]))-("y"==e&&c==h?-1:1)*g[0][e]-("x"==e)*b.widthOfOneDigit/2*b.formatter(f).length-("x"==e)*b.widthOfOneDigit/2*b.formatter(a[0]).length-("y"==e)*b.heightOfOneDigit*.7;k>0&&(k=0),l>0&&(l=0),g[j]={x:0,y:0},g[j][e]=("y"==e&&c==h?-1:1)*(k-l)}}),g}function g(a,b,c,e,f){return d.labelerOptions().isDevMode?null!=f?void console.log(a,b,c,e,f):null!=e?void console.log(a,b,c,e):null!=c?void console.log(a,b,c):null!=b?void console.log(a,b):null!=a?void console.log(a):void 0:void 0}var h="vertical axis",i="horizontal axis",j="labels stack side by side",k="labels stack top to bottom",l="optimistic approximation: labels have different lengths",m="pessimistic approximation: all labels have the largest length",n=10;d.highlightValueRun=function(a){var b="top"==d.orient()||"bottom"==d.orient()?i:h;a.selectAll(".tick").each(function(a,b){d3.select(this).select("text").transition().duration(p).ease("linear").style("opacity","none"==o?1:Math.min(1,Math.pow(Math.abs(d.scale()(a)-d.scale()(o))/(d.scale().range()[1]-d.scale().range()[0])*5,2)))}),a.select(".vzb-axis-value").transition().duration(p).ease("linear").attr("transform","none"==o?"translate(0,0)":"translate("+(b==i?d.scale()(o):0)+","+(b==h?d.scale()(o):0)+")"),a.select(".vzb-axis-value").select("text").text(d.tickFormat()("none"==o?0:o)).style("opacity","none"==o?0:1),o=null};var o=null;d.highlightValue=function(a){return arguments.length?(o=a,d):o};var p=0;d.highlightTransDuration=function(a){return arguments.length?(p=a,d):p};var q=null;d.repositionLabels=function(a){return arguments.length?(q=a,d):q};var r=!1;d.pivot=function(a){return arguments.length?(r=!!a,d):r};var s=[];d.tickValuesMinor=function(a){return arguments.length?(s=a,d):s};var t={outbound:0,inbound:0};d.tickSizeMinor=function(a,b){return arguments.length?(t={outbound:a,inbound:b||0},g("setting",t),d):t};var u={};return d.labelerOptions=function(a){return arguments.length?(u=a,d):u},d.labelFactory=function(a){function b(b,c){return null==c&&(c=a.logBase),Math.log(b)/Math.log(c)}if(this.METHOD_REPEATING="repeating specified powers",this.METHOD_DOUBLING="doubling the value",null==a&&(a={}),"linear"!=a.scaleType&&"time"!=a.scaleType&&"genericLog"!=a.scaleType&&"log"!=a.scaleType&&"ordinal"!=a.scaleType)return d.ticks(v).tickFormat(null).tickValues(null).tickValuesMinor(null).pivot(null).repositionLabels(null);if("ordinal"==a.scaleType)return d.tickValues(null);null==a.logBase&&(a.logBase=n),null==a.baseValues&&(a.stops=[1,2,5,3,7,4,6,8,9]),null==a.removeAllLabels&&(a.removeAllLabels=!1),null==a.formatterRemovePrefix&&(a.formatterRemovePrefix=!1),null==a.formatter&&(a.formatter=function(b){if("time"==a.scaleType)return b instanceof Date||(b=new Date(b)),d3.time.format("%Y")(b);var c="f",d=0;Math.abs(b)<1&&(d=1,c="r");var e="";if(a.formatterRemovePrefix)return d3.format("."+d+c)(b);switch(Math.floor(Math.log10(Math.abs(b)))){case-13:b=1e12*b,e="p";break;case-10:b=1e9*b,e="n";break;case-7:b=1e6*b,e="µ";break;case-6:b=1e6*b,e="µ";break;case-5:b=1e6*b,e="µ";break;case-4:break;case-3:break;case-2:break;case-1:break;case 0:break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:b/=1e3,e="k";break;case 6:b/=1e6,e="M",d=1;break;case 7:b/=1e6,e="M";break;case 8:b/=1e6,e="M";break;case 9:b/=1e9,e="B",d=1;break;case 10:b/=1e9,e="B";break;case 11:b/=1e9,e="B";break;case 12:b/=1e12,e="T",d=1;break;default:return d3.format("."+d+"s")(b).replace("G","B")}return(d3.format("."+d+c)(b)+e).replace("G","B")}),a.cssLabelMarginLimit=5,(null==a.cssMarginLeft||parseInt(a.cssMarginLeft)<a.cssLabelMarginLimit)&&(a.cssMarginLeft=a.cssLabelMarginLimit+"px"),(null==a.cssMarginRight||parseInt(a.cssMarginRight)<a.cssLabelMarginLimit)&&(a.cssMarginRight=a.cssLabelMarginLimit+"px"),(null==a.cssMarginTop||parseInt(a.cssMarginTop)<a.cssLabelMarginLimit)&&(a.cssMarginTop=a.cssLabelMarginLimit+"px"),(null==a.cssMarginBottom||parseInt(a.cssMarginBottom)<a.cssLabelMarginLimit)&&(a.cssMarginBottom=a.cssLabelMarginLimit+"px"),null==a.toolMargin&&(a.toolMargin={left:30,bottom:30,right:30,top:30}),null==a.pivotingLimit&&(a.pivotingLimit=a.toolMargin[this.orient()]),null==a.showOuter&&(a.showOuter=!1),null==a.limitMaxTickNumber&&(a.limitMaxTickNumber=0);var j="top"==this.orient()||"bottom"==this.orient()?i:h;null==a.isPivotAuto&&(a.isPivotAuto=j==h),null==a.cssFontSize&&(a.cssFontSize="13px"),null==a.widthToFontsizeRatio&&(a.widthToFontsizeRatio=.75),null==a.heightToFontsizeRatio&&(a.heightToFontsizeRatio=1.2),null==a.widthOfOneDigit&&(a.widthOfOneDigit=parseInt(a.cssFontSize)*a.widthToFontsizeRatio),null==a.heightOfOneDigit&&(a.heightOfOneDigit=parseInt(a.cssFontSize)*a.heightToFontsizeRatio),g("********** "+j+" **********");var k=d.scale().domain(),o=d.scale().range(),p=(Math.abs(k[k.length-1]-k[0]),Math.abs(o[o.length-1]-o[0])),q=d3.min([k[0],k[k.length-1]]),r=d3.max([k[0],k[k.length-1]]),s=0>q&&r>0&&"time"!=a.scaleType;s&&"log"==a.scaleType&&console.error("It looks like your "+j+" log scale domain is crossing ZERO. Classic log scale can only be one-sided. If need crossing zero try using genericLog scale instead");var t=a.showOuter?[q,r]:[],u=[],v=5,w=d3.max(d3.range(q,r,(r-q)/17).concat(r).map(function(b){return a.formatter(b).length}))*a.widthOfOneDigit+parseInt(a.cssMarginLeft),x=a.isPivotAuto&&(w+d.tickPadding()+d.tickSize()>a.pivotingLimit&&j==h||!(w+d.tickPadding()+d.tickSize()>a.pivotingLimit)&&!(j==h)),y=j==i&&x||j==h&&!x,z=!y&&a.heightOfOneDigit>a.pivotingLimit;if(a.removeAllLabels)return d.tickValues([]);if(q==r)return d.tickValues([q]).ticks(1).tickFormat(a.formatter);var A=function(b,c,e,f){if(null==b||b.length<=1)return!0;if(null==e&&(e=m),null==f&&(scaleType="none"),y)return c>b.length*(a.heightOfOneDigit+parseInt(a.cssMarginTop)+parseInt(a.cssMarginBottom));var g=parseInt(a.cssMarginLeft)+parseInt(a.cssMarginRight),h=d3.max(b.map(function(b){return a.formatter(b).length}));return"log"==f?(c=Math.abs(d.scale()(d3.max(b))-d.scale()(d3.min(b))),c>d3.sum(b.map(function(b){return(a.widthOfOneDigit*(e==m?h:a.formatter(b).length)+g)*(1+Math.log10((b+"").substr(0,1)))}))):c>b.length*g+(e==m?a.widthOfOneDigit*b.length*h:0)+(e==l?a.widthOfOneDigit*b.map(function(b){return a.formatter(b)}).join("").length:0)},B=function(b,c){if(null==c||0==c.length)return!1;c instanceof Array||(c=[c]);for(var e=0;e<c.length;e++)if(b!=c[e]&&0!=b&&Math.abs(d.scale()(b)-d.scale()(c[e]))<(y?a.heightOfOneDigit:(a.formatter(b).length+a.formatter(c[e]).length)*a.widthOfOneDigit/2))return!0;return!1};if("genericLog"==a.scaleType||"log"==a.scaleType){var C=d.scale().eps?d.scale().eps():0,D=s?[0]:[],E=C>r?[]:d3.range(Math.floor(b(Math.max(C,q))),Math.ceil(b(r)),1).concat(Math.ceil(b(r))).map(function(b){return Math.pow(a.logBase,b)}),F=q>-C?[]:d3.range(Math.floor(b(Math.max(C,-r))),Math.ceil(b(-q)),1).concat(Math.ceil(b(-q))).map(function(b){return-Math.pow(a.logBase,b)});if(null==a.method){var G=s?Math.max(Math.abs(r),Math.abs(q))/C:Math.max(Math.abs(r),Math.abs(q))/Math.min(Math.abs(r),Math.abs(q));a.method=G>=10&&1024>=G?this.METHOD_DOUBLING:this.METHOD_REPEATING}if(a.method==this.METHOD_DOUBLING){var H=[];s&&t.push(0);var I=[].concat(t),J=C>r?null:4*E[Math.floor(E.length/2)-1],K=q>-C?null:4*F[Math.floor(F.length/2)-1];if(J)for(var L=J;r>=L;L*=2)H.push(L);if(J)for(var L=J/2;L>=Math.max(q,C);L/=2)H.push(L);if(K)for(var L=K;L>=q;L*=2)H.push(L);if(K)for(var L=K/2;L<=Math.min(r,-C);L/=2)H.push(L);H=H.sort(d3.ascending).filter(function(a){return a>=q&&r>=a}),u=u.concat(H),H=e(H,!1);for(var M=t,N=0;N<H.length;N++){var O=M.concat(H[N]).filter(function(a){return!B(a,I)}).filter(c);if(!A(O,p,m,"none"))break;t=O}}if(a.method==this.METHOD_REPEATING){var P=D.concat(E).concat(F).sort(d3.ascending);a.stops.forEach(function(a,b){u=u.concat(P.map(function(b){return b*a}))}),P=e(P);var I=D.concat(t),Q=!1;a.stops.forEach(function(b,d){if(0==d){for(var e=0;e<P.length;e++){var f=t.concat(P[e].map(function(a){return a*b})).filter(function(a){return!B(a,I)}).filter(function(a){return a>=q&&r>=a}).filter(c);if(!A(f,p,l,"none"))break;t=f}P=[].concat.apply([],P)}else{if(Q)return;var f=t.concat(P.map(function(a){return a*b})).filter(function(a){return a>=q&&r>=a}).filter(c);if(!A(f,p,m,"log"))return void(Q=!0);if(t.length>a.limitMaxTickNumber&&0!=a.limitMaxTickNumber)return void(Q=!0);t=f}})}}if("linear"==a.scaleType||"time"==a.scaleType){s&&t.push(0);var I=[].concat(t);v=Math.max(Math.floor(p/w),2),0!=a.limitMaxTickNumber&&v>a.limitMaxTickNumber&&(v=a.limitMaxTickNumber);var R=d.scale().ticks.apply(d.scale(),[v]).sort(d3.ascending).filter(function(a){return a>=q&&r>=a});u=u.concat(R),R=e(R,!1);for(var M=t,N=0;N<R.length;N++){var O=M.concat(R[N]).filter(function(a){return!B(a,I)}).filter(c);if(!A(O,p,m,"none"))break;t=O}t=t.filter(function(a){return!B(a,I)}).filter(c)}return null!=t&&t.length<=2&&!s&&(t=[q,r]),null!=t&&t.length<=3&&s&&(t=B(0,[q,r])?[q,r]:[q,0,r]),null!=t&&t.sort(function(a,b){return(j==i?-1:1)*(d.scale()(b)-d.scale()(a))}),z&&(t=[]),u=u.filter(function(a){return-1==t.indexOf(a)&&a>=q&&r>=a}),g("final result",t),d.ticks(v).tickFormat(a.formatter).tickValues(t).tickValuesMinor(u).pivot(x).repositionLabels(f(t,a,j,d.scale(),y?"y":"x"))},d.copy=function(){return a(d3.svg.axis())},d3.rebind(d,b,"scale","orient","ticks","tickValues","tickFormat","tickSize","innerTickSize","outerTickSize","tickPadding","tickSubdivide")}(d3.svg.axis())})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.collisionResolver=function(){return function(){function a(l){return null==e?void console.warn("D3 collision resolver stopped: missing data to work with. Example: data = {asi: {valueY: 45, valueX: 87}, ame: {valueY: 987, valueX: 767}}"):null==f?void console.warn("D3 collision resolver stopped: missing a CSS slector"):null==g?void console.warn("D3 collision resolver stopped: missing height of the canvas"):null==i?void console.warn("D3 collision resolver stopped: missing pointer within data objects. Example: value = 'valueY' "):(l.each(function(a,b){c[a.geo]=d3.select(this).select(f)[0][0].getBBox().height}),d=a.calculatePositions(e,i,g,h),void l.each(function(a,c){if(!e[a.geo][j]){var g=d[a.geo]||h(e[a.geo][i])||0,l=null;return null!=k?void k(a,c,this,l,g):void d3.select(this).selectAll(f).transition().duration(b).attr("transform","translate(0,"+g+")")}}))}var b=300,c={},d={};a.calculatePositions=function(a,b,d,e){var f={},g=Object.keys(a).sort(function(c,d){return a[c][b]-a[d][b]});g.forEach(function(d,h){f[d]=e(a[d][b]);for(var i=h;i>0;i--){var j=f[g[i-1]]-f[g[i]]-c[g[i]];if(0>j&&(f[g[i-1]]-=j),j>0)break}});var h=d-f[g[0]]-c[g[0]];if(0>h){f[g[0]]+=h;for(var i=0;i<g.length-1;i++){var h=f[g[i]]-f[g[i+1]]-c[g[i+1]];if(0>h&&(f[g[i+1]]+=h),h>0)break}}return f};var e=null;a.data=function(b){return arguments.length?(e=b,a):e};var f=null;a.selector=function(b){return arguments.length?(f=b,a):f};var g=null;a.height=function(b){return arguments.length?(g=b,a):g};var h=d3.scale.linear().domain([0,1]).range([0,1]);a.scale=function(b){return arguments.length?(h=b,a):h};var i=null;a.value=function(b){return arguments.length?(i=b,a):i};var j=null;a.fixed=function(b){return arguments.length?(j=b,a):j};var k=null;return a.handleResult=function(b){return arguments.length?(k=b,a):k},a}()})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.colorPicker=function(){return function(){function a(){for(var a=[],c=0;f>c;c++){var l=g+(1-g)/f*c;a.push([]);for(var m=0;d>=m;m++){var n=e+(1-e)/d*m;a[c].push({display:b(n,0==m?k:h,0==c?i:l),meaning:b(n,0==m?k:h,0==c?j:l)})}}return a}function b(a,b,c){var d,e,f;if(0==b)d=e=f=c;else{var g=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;d=g(i,h,a+1/3),e=g(i,h,a),f=g(i,h,a-1/3)}return"#"+Math.round(255*d).toString(16)+Math.round(255*e).toString(16)+Math.round(255*f).toString(16)}function c(b){q=a(),t=b.append("svg").style("position","absolute").style("top","0").style("left","0").style("width","100%").style("height","100%").attr("class",p.COLOR_PICKER).classed(p.INVISIBLE,!v);var c=parseInt(t.style("width")),d=parseInt(t.style("height")),e=c/2*(1-m.left-m.right);y=t.append("rect").attr("width",c).attr("height",d).attr("class",p.COLOR_BUTTON+" "+p.COLOR_BACKGR).on("mouseover",function(a){C(n)});var g=t.append("g").attr("transform","translate("+(e+c*m.left)+","+(e+d*m.top)+")");t.append("rect").attr("class",p.COLOR_SAMPLE).attr("width",c/2).attr("height",d*m.top/2),w=t.append("rect").attr("class",p.COLOR_SAMPLE).attr("width",c/2).attr("x",c/2).attr("height",d*m.top/2),t.append("text").attr("x",c*m.left).attr("y",d*m.top/2).attr("dy","0.5em").style("text-anchor","start").attr("class",p.COLOR_SAMPLE),x=t.append("text").attr("x",c*(1-m.right)).attr("y",d*m.top/2).attr("dy","0.5em").style("text-anchor","end").attr("class",p.COLOR_SAMPLE),t.append("text").attr("x",.1*c).attr("y",d*(1-m.bottom)).attr("dy","0.3em").style("text-anchor","start").text("default"),t.append("circle").attr("class",p.COLOR_DEFAULT+" "+p.COLOR_BUTTON).attr("r",c*m.left/2).attr("cx",c*m.left*1.5).attr("cy",d*(1-1.5*m.bottom)).on("mouseover",function(){d3.select(this).style("stroke","#444"),C(o)}).on("mouseout",function(){d3.select(this).style("stroke","none")}),g.append("circle").attr("r",l-1).attr("fill","#FFF").attr("class",p.COLOR_BUTTON).on("mouseover",function(){d3.select(this).style("stroke","#444"),C("#FFF")}).on("mouseout",function(){d3.select(this).style("stroke","none")}),g.selectAll("."+p.COLOR_CIRCLE).data(q).enter().append("g").attr("class",p.COLOR_CIRCLE).each(function(a,b){r.outerRadius(l+(e-l)/f*(f-b)).innerRadius(l+(e-l)/f*(f-b-1));var c=d3.select(this).selectAll("."+p.COLOR_SEGMENT).data(s(a)).enter().append("g").attr("class",p.COLOR_SEGMENT);c.append("path").attr("class",p.COLOR_BUTTON).attr("d",r).style("fill",function(a){return a.data.display}).style("stroke",function(a){return a.data.display}).on("mouseover",function(a){C(a.data.meaning,this)}).on("mouseout",function(a){D()})}),u=g.append("path").attr("class",p.COLOR_POINTER+" "+p.INVISIBLE),t.selectAll("."+p.COLOR_BUTTON).on("click",function(){B.show(E)}),A(t)}var d=15,e=0,f=4,g=.5,h=.7,i=.4,j=.3,k=0,l=15,m={top:.1,bottom:.1,left:.1,right:.1},n="#000",o="#000",p={INVISIBLE:"vzb-invisible",COLOR_POINTER:"vzb-colorPicker-colorPointer",COLOR_BUTTON:"vzb-colorPicker-colorCell",COLOR_DEFAULT:"vzb-colorPicker-defaultColor",COLOR_SAMPLE:"vzb-colorPicker-colorSample",COLOR_PICKER:"vzb-colorPicker-colorPicker",COLOR_CIRCLE:"vzb-colorPicker-colorCircle",COLOR_SEGMENT:"vzb-colorPicker-colorSegment",COLOR_BACKGR:"vzb-colorPicker-background"},q=[],r=d3.svg.arc(),s=d3.layout.pie().sort(null).value(function(a){return 1}),t=null,u=null,v=!1,w=null,x=null,y=null,z=function(a){console.info("Color picker callback example. Setting color to "+a)},A=function(a){a.select("."+p.COLOR_BACKGR).style("fill","white"),a.select("."+p.COLOR_POINTER).style("stroke-width",2).style("stroke","white").style("pointer-events","none").style("fill","none"),a.selectAll("."+p.COLOR_BUTTON).style("cursor","pointer"),a.selectAll("text").style("dominant-baseline","hanging").style("fill","#D9D9D9").style("font-size","0.7em").style("text-transform","uppercase"),a.selectAll("circle."+p.COLOR_BUTTON).style("stroke-width",2)},B=c,C=function(a,b){null!=b&&u.classed(p.INVISIBLE,!1).attr("d",d3.select(b).attr("d")),w.style("fill",a),x.text(a),z(a)},D=function(){u.classed(p.INVISIBLE,!0)},E="toggle";return c.show=function(a){return arguments.length?(null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),v=a==E?!v:a,void t.classed(p.INVISIBLE,!v)):v},c.nCellsH=function(a){return arguments.length?(d=a,c):d},c.minH=function(a){return arguments.length?(e=a,c):e},c.nCellsL=function(a){return arguments.length?(f=a,c):f},c.minL=function(a){return arguments.length?(g=a,c):g},c.outerL_display=function(a){return arguments.length?(i=a,c):i},c.outerL_meaning=function(a){return arguments.length?(j=a,c):j},c.satConstant=function(a){return arguments.length?(h=a,c):h},c.firstAngleSat=function(a){return arguments.length?(k=a,c):k},c.minRadius=function(a){return arguments.length?(l=a,c):l},c.margin=function(a){return arguments.length?(m=a,c):m},c.callback=function(a){return arguments.length?(z=a,c):z},c.colorDef=function(a){return arguments.length?(o=a,null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),t.select("."+p.COLOR_DEFAULT).style("fill",o),c):o},c.colorOld=function(a){return arguments.length?(n=a,null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),t.select("rect."+p.COLOR_SAMPLE).style("fill",n),t.select("text."+p.COLOR_SAMPLE).text(n),c):n},c}()})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.scale.genericLog=function(){return function a(b){function c(a){var c=1,e=0,h=0,k=0,l=f[0]<f[f.length-1],m=g[0]<g[g.length-1];if(d3.min(f)<0&&d3.max(f)>0){var n=d3.min(j([f[0],f[f.length-1]]));c=l!=m?(d3.max(g)+d3.max(g)-b(Math.max(d,n)))/d3.max(g):(d3.max(g)+b(Math.max(d,n)))/d3.max(g),l&&!m?(e=(d3.max(g)+i(0))/c,j(f[0])>j(f[f.length-1])&&(k-=b(Math.max(d,n))/c)):l||m?l&&m?(k=d3.max(g)/c,j(f[0])<j(f[f.length-1])&&(k-=(d3.max(g)-b(Math.max(d,n)))/c)):!l&&m&&(e=(d3.max(g)+i(0))/c,j(f[0])<j(f[f.length-1])&&(k-=b(Math.max(d,n))/c)):(k=b(Math.max(d,n))/c,j(f[0])<j(f[f.length-1])&&(k+=(d3.max(g)-b(Math.max(d,n)))/c))}else d3.min(f)<0&&d3.max(f)<0&&(e=d3.max(g));return a>d?b(a)/c+k+h:-d>a?-b(-a)/c+k+e:a>=0&&d>=a?i(a)/c+k+h:a>=-d&&0>a?-i(-a)/c+k+e:void 0}var d=.001,e=5,f=b.domain(),g=b.range(),h=!1,i=d3.scale.linear().domain([0,d]).range([0,e]),j=function(a){return a instanceof Array?a.map(function(a){return Math.abs(a)}):Math.abs(a)},k=function(a){for(var b=Math.sign(a[0]),c=0;c<a.length;c++)if(Math.sign(a[c])!=b)return!1;return!0};return c.eps=function(a){
return arguments.length?(d=a,c.domain(f),c):d},c.delta=function(a){return arguments.length?(e=a,c.range(g),c):e},c.domain=function(a){if(!arguments.length)return f;var e=[];switch(2!=a.length&&console.warn("generic log scale is best for 2 values in domain, but it tries to support other cases too"),a.length){case 0:e=f;break;case 1:e=[a[0]/2,2*a[0]];break;case 2:e=[a[0],a[1]];break;case 3:e=[a[0],a[2]],d=j(a[1]);break;default:e=[a[0],a[a.length-1]],d=d3.min(j(a.filter(function(b,c){return 0!=c&&c!=a.length-1})))}return e[0]==e[1]&&(e[0]=e[0]/2,e[1]=2*e[1]),k(e)&&d3.min(j(e))>=d?(e[0]>0&&e[1]>0?b.domain(e):b.domain([-e[1],-e[0]]),h=!1):k(e)&&d3.min(j(e))<d?(e[0]>0&&e[1]>0?e[0]<=e[1]?(b.domain([d,e[1]]),i.domain([0,d])):(b.domain([e[0],d]),i.domain([d,0])):e[0]<=e[1]?(b.domain([d,-e[0]]),i.domain([0,d])):(b.domain([-e[1],d]),i.domain([d,0])),h=!0):k(e)||(e[0]<=e[1]?(b.domain([d,d3.max(j(e))]),i.domain([0,d])):(b.domain([d3.max(j(e)),d]),i.domain([d,0])),h=!0),f=a,c},c.range=function(a){if(!arguments.length)return g;switch(2!=a.length&&console.warn("generic log scale is best for 2 values in range, but it tries to support other cases too"),a.length){case 0:a=g;break;case 1:a=[a[0]-100,a[0]+100];break;case 2:a=a;break;case 3:e=a[1],a=[a[0],a[2]];break;default:e=d3.min(a.filter(function(b,c){return 0!=c&&c!=a.length-1})),a=[a[0],a[a.length-1]]}return h?a[0]<a[1]?f[0]<f[f.length-1]?(b.range([e,a[1]]),i.range([0,e])):(b.range([0,a[1]-e]),i.range([a[1]-e,a[1]])):f[0]<f[f.length-1]?(b.range([a[0]-e,0]),i.range([a[0],a[0]-e])):(b.range([a[0],e]),i.range([e,0])):b.range(a),g=a,c},c.copy=function(){return a(d3.scale.log().domain([1,10])).domain(f).range(g).eps(d).delta(e)},d3.rebind(c,b,"invert","base","rangeRound","interpolate","clamp","nice","tickFormat","ticks")}(d3.scale.log().domain([1,10]))})}.call(this);